"""
ALBURY NSW - EXEMPT DEVELOPMENT ASSESSMENT TOOL FOR SHEDS AND PATIOS

STATE ENVIRONMENTAL PLANNING POLICY (Exempt and Complying Development Codes) 2008 (SEPP)


Part 1, Division 2 Exempt and complying development
1.15 What development is exempt development?
    (1) Development is exempt development for the purposes of this Policy if the development—
        (a) is specified in an exempt development code, and
        (b) meets the standards specified for the development, and
        (c) complies with the requirements of this Division for exempt development.
    (2) For the purposes of subclause (1), development that is specified includes any specified limitations as to the land on which that development may be carried out.
        Note—
        Under section 1.6 of the Act, the carrying out of exempt development does not require—
        (a) development consent under Part 4 of the Act, or
        (b) environmental impact assessment under Division 5.1 of the Act, or
        (c) State significant infrastructure approval under Division 5.2 of the Act, or
        (d) a certificate under Part 6 of the Act.
1.16 General requirements for exempt development
    (1) To be exempt development for the purposes of this Policy, the development—
        (a) must meet the relevant deemed-to-satisfy provisions of the Building Code of Australia, or if there are no such relevant provisions, must be structurally adequate, and
        (b) must not, if it relates to an existing building, cause the building to contravene the Building Code of Australia, and
        (b1) must not be carried out on land that is a declared area of outstanding biodiversity value under the Biodiversity Conservation Act 2016 or declared critical habitat under Part 7A 
             of the Fisheries Management Act 1994, and
        (b2) must not be carried out on land that is, or is part of, a wilderness area (within the meaning of Wilderness Act 1987), and
        (c) must not be carried out on land that is, or on which there is, an item that is listed on the State Heritage Register under the Heritage Act 1977, or that is subject to an interim 
            heritage order under that Act, and
        (d) must not be carried out on land that is described or otherwise identified on a map specified in Schedule 4.
    (1A) Despite subclause (1)(c), if development meets the requirements and standards specified by this Policy and that development—
        (a) has been granted an exemption under section 57(2) of the Heritage Act 1977, or
        (b) is subject to an exemption under section 57(1A) or (3) of that Act, the development is exempt development under this Policy.
    (1B) If an item listed on the State Heritage Register is not located on, or does not comprise, the whole of the relevant land, subclause (1)(c) applies only to the part of the land that is described 
         and mapped on that register.
    (1C) If an item not listed on the State Heritage Register but identified as an item of environmental heritage in an environmental planning instrument does not comprise, or is not located on, the whole of 
         the relevant land, any restriction on carrying out development on the relevant land on which the item is located applies only to the part of the land that is described and mapped on that instrument.
    (2) Development that relates to an existing building that is classified under the Building Code of Australia as class 1b or class 2–9 is exempt development for the purposes of this Policy only if—
        (a) the building has a current fire safety certificate or fire safety statement, or
        (b) no fire safety measures are currently implemented, required or proposed for the building.
    (3) To be exempt development for the purposes of this Policy, the development must—
        (a) be installed in accordance with the manufacturer’s specifications, if applicable, and
        (b) not involve the removal or pruning of a tree or other vegetation that requires a permit, approval or development consent, unless the removal or pruning is carried out in accordance with the permit, 
            approval or development consent,
            Example—
            A permit or approval may be required under State Environmental Planning Policy (Biodiversity and
            Conservation) 2021, Chapter 2 or other legislation.
        (c) not involve the removal of—
            (i) non-friable asbestos from an area of more than 10m2, or
            (ii) friable asbestos.
            Note—
            Residential buildings constructed before 1990 may contain asbestos. See Code of practice: How to
            safely remove asbestos published by SafeWork NSW in December 2022 and www.asbestos.nsw.gov.au for further information.
    (4) Subclause (3)(c) does not apply if the removal is carried out by a licensed asbestos removalist.
    (5) In this clause—
        friable asbestos, licensed asbestos removalist and non-friable asbestos have the same meaning as in the Work Health and Safety Regulation 2017.
1.16A Exempt development on land within 18km of Siding Spring Observatory
    (1) Development on land that is less than 18km from the Siding Spring Observatory is not exempt development for the purposes of this Policy if the development has, or will
        require, any form of lighting.
    (2) Development specified in Part 2, Division 1, Subdivision 10A, 10B, 27, 27A or 37 on land that is less than 18km from the Siding Spring Observatory is not exempt
        development for the purposes of this Policy.


Part 2, Division 2, Subdivision 6 Balconies, decks, patios, pergolas, terraces and verandahs
2.11 Specified development
The following development is specified for this code—
    (a) the construction or installation of a balcony, deck, patio, pergola, terrace or verandah, whether free standing or attached to the ground floor level of a building, or roofed or
        unroofed, if it is not constructed or installed on or in a heritage item or a draft heritage item or on land in a foreshore area,
    (b) the replacement of a deck if the deck is not higher than 1m above ground level (existing).
2.12 Development standards
    (1) The standards specified for the development specified in clause 2.11(a) are that the development must—
        (a) (Repealed)
        (b) have an area of not more than 25m2, and
        (c) not cause the total floor area of all such structures on the lot to be more than—
            (i) for a lot larger than 300m2—15% of the ground floor area of the dwelling on  the lot, or
            (ii) for a lot 300m2 or less—25m2, and
        (d) not have an enclosing wall higher than 1.4m, and
        (e) be located—
            (i) if carried out in connection with farm experience premises or farm gate premises—more than 50m from a road, or
            (ii) otherwise—behind the building line of a road frontage, and
        (f) be located at a distance from each lot boundary of at least—
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5—5m, or
            (ii) for development carried out in any other zone—900mm, and
        (g) (Repealed)
        (h) to the extent it is comprised of metal components—be constructed of low reflective, factory pre-coloured materials, and
        (i) have a floor height not more than 1m above ground level (existing), and
        (i1) if it is a roofed structure—have a roof that does not overhang the structure by more than 600mm on each side,
        (j) if it is a roofed structure attached to a dwelling—not extend above the roof gutter line of the dwelling, and
        (j1) be no higher than 3m at its highest point above ground level (existing), and
        (k) if it is connected to a fascia—be connected in accordance with a professional engineer’s specifications, and
        (l) be constructed or installed so that any roofwater is disposed of into an existing stormwater drainage system, and
        (m) not interfere with the functioning of existing drainage fixtures or flow paths, and
        (n) if it is located on bush fire prone land and is less than 5m from a dwelling—be constructed of non-combustible material. and
        (o) (Repealed)
    (2) The standards specified for the development specified in clause 2.11(b) are that the development must—
        (a) use equivalent or improved quality materials, and
        (b) not change the size or height of the existing deck.
    (3) Subclause (1)(h) does not apply to development carried out in connection with a building used for the purposes of farm stay accommodation, farm gate premises or farm experience premises.


Division 2, Subdivision 9 Cabanas, cubby houses, ferneries, garden sheds,
gazebos and greenhouses
2.17 Specified development
The construction or installation of a cabana, cubby house, fernery, garden shed, gazebo or greenhouse is development specified for this code if it is not constructed or installed on or
in a heritage item or a draft heritage item, on land in a foreshore area or in an environmentally sensitive area.
2.18 Development standards
    (1) The standards specified for that development are that the development must—
        (a) (Repealed)
        (b) not have a floor area of more than—
            (i) on land in Zone RU1, RU2, RU3, RU4, RU6 or R5—50m2, or
            (ii) on land in any other zone—20m2, and
        (c) be not higher than 3m above ground level (existing), and
        (d) be located at a distance from each lot boundary of at least—
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5—5m, or
            (ii) for development carried out in any other zone—900mm, and
        (e) if it is not on land in Zone RU1, RU2, RU3, RU4 or RU6—be located behind the building line of any road frontage, and
        (f) not be a shipping container, and
        (g) be constructed or installed so that roofwater is disposed of without causing a nuisance to adjoining owners, and
        (h) to the extent it is comprised of metal components—be constructed of low reflective, factory pre-coloured materials if it is located on land in a residential zone, and
        (i) if it is located on bush fire prone land and is less than 5m from a dwelling—be constructed of non-combustible material, and
        (j) if it is constructed or installed in a heritage conservation area or a draft heritage conservation area—be located in the rear yard, and
        (k) if it is located adjacent to another building—be located so that it does not interfere with the entry to, or exit from, or the fire safety measures contained within, that building, and
        (l) be a Class 10 building and not be habitable, and
        (m) be located at least 1m from any registered easement, and
        (n) in relation to a cabana—not be connected to water supply or sewerage services.
    (2) There must not be more than 2 developments per lot.

"""

def get_valid_input(prompt, valid_options):
    """ This function checks input for a string field to make sure it mathes one of ["valid options"]
        Keeps requesting valid input if user does not choose a valid option"""
    
    while True:
        response = input(prompt).strip().lower()
        if response in valid_options:
            return response
        print(f"❌ Invalid input. Please enter one of: {', '.join(valid_options)}")


def get_valid_number(prompt, number_type=float, min_value=None, max_value=None):
    """ This function checks input for a number field optionally within valid limits min_value and max_value 
        Keeps requesting valid input if user does not choose a valid option"""
    
    while True:
        try:
            value = number_type(input(prompt).strip())
            if (min_value is not None and value < min_value) or \
               (max_value is not None and value > max_value):
                print(f"❌ Value must be between {min_value} and {max_value}.")
                continue
            return value
        except ValueError:
            print("❌ Invalid input. Please enter a valid number.")


def patio_check():
    """ This function provides the rule-set for Exempt Development of a Patio under the SEPP
        returning a string indicating if the proposed development is Exempt or if not, returning
        a string indicating reson for Not Exempt under SEPP"""
    
    print("\n🪴 Patio Development Check\n")

    if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
        return "❌ Zoning is out of scope of this tool - only zones R1-R6 and RU1-RU4 and RU6 are assessable with this tool"

    if attributes["structure_type"] == "replacement":
        if attributes["height_existing"] > 1:
            return "❌ Not Exempt: Existing height exceeds 1m. (SEPP, Part 2, Division 1, Subdivision 6, 2.11 (b))"

        if attributes["material_quality"] == "no":
            return "❌ Not Exempt: Material quality not met. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (2)(a))"
    
        if attributes["structure_type"] == "replacement" and attributes["same_size"] == "no":
            return "❌ Not Exempt: Replacement not same size. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (2)(b))"

    if attributes["heritage"] == "yes":
        return "❌ Not Exempt: Heritage item. (SEPP, Part 2, Division 1, Subdivision 6, 2.11 (a))"

    if attributes["foreshore"] == "yes":
        return "❌ Not Exempt: Foreshore area. (SEPP, Part 2, Division 1, Subdivision 6, 2.11 (a))"

    if attributes["area"] > 25:
        return "❌ Not Exempt: Area exceeds limits. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(b))"
    else:
        if attributes["land_size"] > 300:
            if attributes["total_structures_area"] > 0.15 * attributes["land_size"]:
                return "❌ Not Exempt: Area exceeds limits. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(c)(i))"
        else:
            if attributes["total_structures_area"] > 25:
                return "❌ Not Exempt: Area exceeds limits. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(c)(ii))"

    if attributes["wall_height"] == "yes":
        return "❌ Not Exempt: Wall height exceeds limit. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(d))"

    if attributes["behind_building_line"] == "no":
        return "❌ Not Exempt: Not behind building line. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(e)(ii))"

    if attributes["boundary_distance"] < 900:
        return "❌ Not Exempt: Too close to boundary. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(f)(ii))"
    elif attributes["boundary_distance"] < 5000:
        if attributes["zoning"] not in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            return "❌ Not Exempt: Too close to boundary. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(f)(i))" 

    if attributes["metal"] == "yes":
        if attributes["reflective"] == "no":
            return "❌ Not Exempt: Metal components not compliant. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(h))"

    if attributes["floor_height"] > 1000:
        return "❌ Not Exempt: Floor height exceeds 1m. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(i))"

    if attributes["roof"] == "yes":
        if attributes["overhang"] > 600:
            return "❌ Not Exempt: Roof overhang exceeds 600mm. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(i1))"

        if attributes["attached"] == "yes":
            if attributes["above_gutter"] == "yes":
                return "❌ Not Exempt: Roof extends above gutter. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(j))"

            if attributes["roof_height"] > 3:
                return "❌ Not Exempt: Roof height exceeds 3m. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(j1))"

            if attributes["fascia_connection"] == "yes":
                if attributes["engineer_spec"] == "no":
                    return "❌ Not Exempt: Fascia connection not compliant. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(k))"

            if attributes["stormwater"] == "no":
                return "❌ Not Exempt: No stormwater disposal. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(l))"

    if attributes["drainage"] == "yes":
        return "❌ Not Exempt: Interferes with drainage. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(m))"

    if attributes["bushfire"] == "yes":
        if attributes["distance_dwelling"] < 5:
            if attributes["non_combustible"] == "no":
                return "❌ Not Exempt: Bushfire material standards not met. (SEPP, Part 2, Division 1, Subdivision 6, 2.12 (1)(n))"

    return "✅ Exempt Development: Patio meets criteria set out in SEPP, Part 2, Division 1, Subdivision 6, 2.11 and 2.12"


def shed_check():
    """ This function provides the rule-set for Exempt Development of a Shed under the SEPP
        returning a string indicating if the proposed development is Exempt or if not, returning
        a string indicating reson for Not Exempt under SEPP"""

    print("\n🔧 Shed Development Check\n")

    if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
        return "❌ Zoning is out of scope of this tool - only zones R1-R6 and RU1-RU4 and RU6 are assessable with this tool"

    if attributes["heritage"] == "yes":
        return "❌ Not Exempt: Heritage item. (SEPP, Part 2, Division 1, Subdivision 6, 2.17)"

    if attributes["foreshore"] == "yes":
        return "❌ Not Exempt: Foreshore area. (SEPP, Part 2, Division 1, Subdivision 6, 2.17)"

    if attributes["sensitive_area"] == "yes":
        return "❌ Not Exempt: Environmentally sensitive area. (SEPP, Part 2, Division 1, Subdivision 6, 2.17)"

    if attributes["area"] > 20:
        return "❌ Not Exempt: Area exceeds 20m². (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(b))"

    if attributes["height"] > 3:
        return "❌ Not Exempt: Height exceeds 3m. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(c))"

    if attributes["boundary_distance"] < 900:
        return "❌ Not Exempt: Too close to boundary. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(d)(ii))"
    elif attributes["boundary_distance"] < 5000:
        if attributes["zoning"] not in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            return "❌ Not Exempt: Too close to boundary. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(d)(i))" 

    if attributes["building_line"] == "no":
        if attributes["zoning"] not in ["RU1", "RU2", "RU3", "RU4", "RU6"]:
            return "❌ Not Exempt: Not behind building line. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(e))"

    if attributes["shipping_container"] == "yes":
        return "❌ Not Exempt: Shipping containers not allowed. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(f))"

    if attributes["stormwater"] == "no":
        return "❌ Not Exempt: Stormwater disposal not compliant. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(g))"

    if attributes["metal"] == "yes":
        if attributes["reflective"] == "no":
            return "❌ Not Exempt: Metal components not compliant. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(h))"

    if attributes["bushfire"] == "yes":
        if attributes["distance_dwelling"] < 5:
            if attributes["non_combustible"] == "no":
                return "❌ Not Exempt: Bushfire standards not met. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(i))"

    if attributes["adjacent_building"] == "yes":
        if attributes["interfere"] == "yes":
            return "❌ Not Exempt: Interferes with building access or safety. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(k))"

    if attributes["habitable"] == "yes":
        return "❌ Not Exempt: Habitable sheds not allowed. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(l))"

    if attributes["easement"] == "yes":
        return "❌ Not Exempt: Too close to easement. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(m))"

    if attributes["services"] == "yes":
        return "❌ Not Exempt: Service connections not allowed. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (1)(n))"

    if attributes["existing_structures"] == "yes":
        return "❌ Not Exempt: Maximum number of structures exceeded. (SEPP, Part 2, Division 1, Subdivision 6, 2.18 (2))"

    return "✅ Exempt Development: Shed meets criteria set out in SEPP, Part 2, Division 1, Subdivision 9, 2.17 and 2.18"


# Run the main function
if __name__ == "__main__":

    ATTRIB_HELP = """

    Welcome to the Exempt Development CLI Tool 🏡

    This tool helps validate planning exemptions for sheds and patios
    based on Albury City Council regulations.

    Example Usage:
        python ExemptAssess.py --attributes shedattributes.json

    Arguments:
    --attributes      Path to the attributes configuration file (JSON format)


    For patio assessment attributes, json file must contain: 
    ----------------------------------------------------------------------------------------
    development = patio
    zoning = Land Zoning choice of R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6
    structure_type = "new","replacement"
    height_existing = Height of existing structure from ground level in meters
    material_quality = Will the structure use equivalent or better quality materials? "yes","no"
    same_size = Will the structure be the same height and size as existing? "yes","no"
    heritage = Is the property a heritage item? "yes","no"
    foreshore = Is the property in a foreshore area? "yes","no"
    area = Planned area of structure (in m²):
    land_size = Land size (in m²): 
    total_structures_area = Total area of planned + existing structures [Balconies, decks, patios, pergolas, terraces and verandahs] (in m²) 
    wall_height = Will any wall exceed 1.4m in height? "yes","no"
    behind_building_line = Is the structure behind the building line of road frontage? "yes","no"
    boundary_distance = Distance from site boundary (in mm): 
    metal = Will the structure use metal components? "yes","no"
    reflective = Are metal components non-reflective or factory coloured? "yes","no"
    floor_height = Floor height from ground level (in mm): 
    roof = Will the structure have a roof? "yes","no"
    overhang = Roof overhang on any side (in mm): 
    attached = Will the roof be attached to the dwelling? "yes","no"
    above_gutter = Will the roof extend above the gutter line? "yes","no"
    roof_height = Roof height above ground level (in meters): 
    fascia_connection = Will the roof be connected to fascia? "yes","no"
    engineer_spec = Will it be connected per engineers specs? "yes","no"
    stormwater = Will roofwater be disposed into existing stormwater system? "yes","no"
    drainage = Will the structure interfere with existing drainage or flow paths? "yes","no"
    bushfire = Is the property on bushfire prone land? "yes","no"
    distance_dwelling = Distance from dwelling (in meters): 
    non_combustible = Will the patio be constructed of non-combustible materials? "yes","no"

    For shed assessment attributes, json file must contain: 
    ----------------------------------------------------------------------------------------
    development = shed
    zoning = Land zoning choice of R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6
    heritage = Is the property a heritage item? "yes","no"
    foreshore = Is the property in a foreshore area? "yes","no"
    sensitive_area = Is the property in an environmentally sensitive area? "yes","no"
    area = Planned shed area (in m²): 
    height = Planned shed height from ground level (in meters): 
    boundary_distance = Distance from any site boundary (in mm): 
    building_line = Is the shed behind the building line of road frontage? "yes","no"
    shipping_container = Is the shed a shipping container? "yes","no"
    stormwater = Will roofwater be disposed of without causing nuisance to adjoining owners? "yes","no"
    metal = Will the shed use metal components? "yes","no"
    reflective = Are metal components low-reflective or factory pre-coloured? "yes","no"
    bushfire = Is the property on bushfire prone land? "yes","no"
    distance_dwelling = Distance from dwelling (in meters): 
    non_combustible = Will the shed be constructed of non-combustible materials? "yes","no"
    adjacent_building = Will the shed be adjacent to an existing building? "yes","no"
    interfere = Will it interfere with entry/exit or fire safety measures of adjacent building? "yes","no"
    habitable = Is the shed planned to be habitable? "yes","no"
    easement = Is the shed within 1m of a registered easement? "yes","no"
    services = Will the shed have water or sewer connections? "yes","no"
    existing_structures = Are there already two of the following on the lot: cabanas, cubby houses, ferneries, garden sheds, gazebos, greenhouses? "yes","no"
    """

    import argparse
    import json
    import os
    import sys

    def load_json_file(file_path):
        if not os.path.exists(file_path):
            print(f"❌ File not found: {file_path}")
            sys.exit(1)
        try:
            with open(file_path, 'r') as f:
                return json.load(f)
        except json.JSONDecodeError as e:
            print(f"❌ Failed to parse JSON: {e}")
            sys.exit(1)
    
    def Assess(attributes):
        print("🏡 Welcome to the Albury Exempt Development Checker for Sheds and Patios\n")

        if attributes["development"] == "patio":
            result = patio_check()
        else:
            result = shed_check()

        print("\n")
        print("--------------------------------------------------------------------------------------------------------------------")
        print("📋 Assessment Result:")
        print(result)  
        print("--------------------------------------------------------------------------------------------------------------------")
        print("################ Subject to conditions listed in SEPP Division 2 - Exempt and Complying Development ################")
        print("--------------------------------------------------------------------------------------------------------------------")
        print("\n")

        exit()


    parser = argparse.ArgumentParser(
        description="Provides and assessment to determine if a planned Shed or Patio development will be an exempt development under SEPP",
        formatter_class=argparse.RawTextHelpFormatter
    )

    parser.add_argument(
        "-a", "--attributes", help=f"JSON file containing attributes for assessment.\n {ATTRIB_HELP}",
        required=True, type=str
    )

    args = parser.parse_args()
    
    attributes = load_json_file(args.attributes)

    Assess(attributes)

    exit()






