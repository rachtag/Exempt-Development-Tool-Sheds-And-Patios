<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exempt Development Assessment Tool for Sheds and Patios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="section">
    <h1>Exempt Development Assessment - Sheds and Patios</h1>
    <h4>Check if your shed or patio in Albury City qualifies as exempt development and can be built without council approval.</h4>
  </div>

  <!-- Address section -->
  <div class="section">
    <p>Please ensure your property is within Albury City before continuing.</p>
    <label for="address">Enter the property address:</label>
    <div class="address-container">
      <input type="text" id="address" placeholder="553 Kiewa St, Albury NSW 2640">
      <div id="results"></div>
    </div>
  </div>

  <!-- Development type -->
  <div class="section">
    <label for="development">Please select the type of structure you are planning to build:</label>
    <select id="development">
      <option value="">-- Select --</option>
      <option value="shed">Shed</option>
      <option value="patio">Patio</option>
    </select>
  </div>

  <!-- Common fields -->
  <div class="section">
    <p>If you are unsure about your property’s zoning, heritage status, or foreshore location, you can check it on the 
      <a href="https://www.planningportal.nsw.gov.au/" target="_blank">NSW Planning Portal</a>.
    </p>
    <label for="zoning">Which zoning applies to your property?</label>
    <select id="zoning">
      <option value="">-- Select --</option>
      <option>R1</option><option>R2</option><option>R3</option><option>R4</option><option>R5</option>
      <option>RU1</option><option>RU2</option><option>RU3</option><option>RU4</option><option>RU5</option><option>RU6</option>
      <option>E1</option><option>E2</option><option>E3</option><option>E4</option><option>E5</option>
      <option>MU1</option>
      <option>SP1</option><option>SP2</option><option>SP3</option><option>SP4</option><option>SP5</option>
      <option>RE1</option><option>RE2</option>
      <option>C1</option><option>C2</option><option>C3</option><option>C4</option>
      <option>W1</option><option>W2</option><option>W3</option><option>W4</option>
    </select>

    <label>Is the property a heritage item?
      <select id="heritage"><option>no</option><option>yes</option></select>
    </label>

    <label>Is the property in a foreshore area?
      <select id="foreshore"><option>no</option><option>yes</option></select>
    </label>

    <!-- Only used for sheds -->
    <label id="sensitive-area-label" class="hidden">Is the property in an environmentally sensitive area?
      <select id="sensitive_area"><option>no</option><option>yes</option></select>
    </label>
  </div>

  <!-- Shed fields -->
  <div id="shed-fields" class="section hidden">
    <h2>Shed Details</h2>
    <label>Planned shed area (in square metres, m²): <input type="number" id="area"></label>
    <label>Planned shed height (in metres, m): <input type="number" step="0.1" id="height"></label>
    <label>Distance from the property boundary (in millimetres, mm): <input type="number" id="boundary_distance"></label>
    <label>Will the shed be located behind the building line?
      <select id="building_line"><option>yes</option><option>no</option></select>
    </label>
    <label>Is the shed a shipping container?
      <select id="shipping_container"><option>no</option><option>yes</option></select>
    </label>
    <label>Will the roofwater be disposed of into an existing stormwater drainage system?
      <select id="stormwater"><option>yes</option><option>no</option></select>
    </label>
    <label>Does the shed use metal components?
      <select id="metal"><option>no</option><option>yes</option></select>
    </label>
    <label>If metal, are the components low-reflective or factory pre-coloured?
      <select id="reflective"><option>yes</option><option>no</option></select>
    </label>
    <label>Is the property on bushfire prone land?
      <select id="bushfire"><option>no</option><option>yes</option></select>
    </label>
    <label>What will be the distance from the dwelling on the lot (in metres, mm)?<input type="number" id="distance_dwelling"></label>
    <label>Will the shed be constructed of non-combustible materials?
      <select id="non_combustible"><option>no</option><option>yes</option></select>
    </label>
    <label>Will the shed be adjacent to an existing building?
      <select id="adjacent_building"><option>no</option><option>yes</option></select>
    </label>
    <label>If adjacent, will the shed interfere with entry/exit or fire safety measures of an adjacent building?
      <select id="interfere"><option>no</option><option>yes</option></select>
    </label>
    <label>Is the shed planned to be habitable?
      <select id="habitable"><option>no</option><option>yes</option></select>
    </label>
    <label>Will the shed be within 1 metre of a registered easement?
      <select id="easement"><option>no</option><option>yes</option></select>
    </label>
    <label>Will the shed have water or sewer connections?
      <select id="services"><option>no</option><option>yes</option></select>
    </label>
    <label>Are there already two of the following on the lot: cabanas, cubby houses, ferneries, garden sheds, gazebos, greenhouses?
      <select id="existing_structures"><option>no</option><option>yes</option></select>
    </label>
  </div>

  <!-- Patio fields -->
  <div id="patio-fields" class="section hidden">
    <h2>Patio Details</h2>
    <label>Will this be a new development or are you replacing an existing structure?
      <select id="structure_type"><option>new</option><option>replacement</option></select>
    </label>
    <label>What is the height of the existing structure from ground level (in metres, m): <input type="number" step="0.1" id="height_existing"></label>
    <label>Will the new structure use equivalent or better quality materials?
      <select id="material_quality"><option>yes</option><option>no</option></select>
    </label>
    <label>Will the new structure be the same height and size as the existing?
      <select id="same_size"><option>yes</option><option>no</option></select>
    </label>
    <label>Planned patio area (in square metres, m²): <input type="number" id="area_patio"></label>
    <label>What is the property lot size (in square metres, m²): <input type="number" id="land_size"></label>
    <label>What is the total area of the planned + existing structures on the site (in square metres, m²): <input type="number" id="total_structures_area"></label>
    <label>Will any wall exceed 1.4 metres in height?
      <select id="wall_height"><option>no</option><option>yes</option></select>
    </label>
    <label>Will the patio be located behind the building line?
      <select id="behind_building_line"><option>yes</option><option>no</option></select>
    </label>
    <label>Distance from the property boundary (in millimetres, mm): <input type="number" id="boundary_distance_patio"></label>
    <label>Does the patio use metal components?
      <select id="metal_patio"><option>no</option><option>yes</option></select>
    </label>
    <label>If metal, are the components low-reflective or factory pre-coloured?
      <select id="reflective_patio"><option>yes</option><option>no</option></select>
    </label>
    <label>What will be the floor height from ground level (in millimetres, mm)? <input type="number" id="floor_height"></label>
    <label>Will the structure have a roof?
      <select id="roof"><option>yes</option><option>no</option></select>
    </label>
    <label>What will be the roof overhang (in millimetres, mm)? <input type="number" id="overhang"></label>
    <label>Does the roof attach to the dwelling?
      <select id="attached"><option>yes</option><option>no</option></select>
    </label>
    <label>Does the roof extend above the gutter line?
      <select id="above_gutter"><option>no</option><option>yes</option></select>
    </label>
    <label>What will be the roof height (in metres, m)? <input type="number" step="0.1" id="roof_height"></label>
    <label>Will the roof be connected to the fascia?
      <select id="fascia_connection"><option>no</option><option>yes</option></select>
    </label>
    <label>If connected, is this as per engineer specs?
      <select id="engineer_spec"><option>yes</option><option>no</option></select>
    </label>
    <label>Will the roofwater be disposed of into an existing stormwater drainage system?
      <select id="stormwater_patio"><option>yes</option><option>no</option></select>
    </label>
    <label>Will the structure interfere with existing drainage or flow paths?
      <select id="drainage"><option>no</option><option>yes</option></select>
    </label>
    <label>Is the property on bushfire prone land?
      <select id="bushfire"><option>no</option><option>yes</option></select>
    </label>
    <label>What will be the distance from the dwelling on the lot (in metres, mm)? <input type="number" id="distance_dwelling_patio"></label>
    <label>Will the patio be constructed of non-combustible materials?
      <select id="non_combustible_patio"><option>no</option><option>yes</option></select>
    </label>
  </div>

  <!-- Submit -->
  <button id="submit">Submit</button>

  <!-- Result -->
  <div class="section">
    <h2>Result</h2>
    <pre id="result"></pre>
  </div>

<script>
const devSelect = document.getElementById("development");
const shedFields = document.getElementById("shed-fields");
const patioFields = document.getElementById("patio-fields");
const sensitiveLabel = document.getElementById("sensitive-area-label");

const AllowedZoning = [
  "R1","R2","R3","R4","R5","RU1","RU2","RU3","RU4","RU5","RU6",
  "E1","E2","E3","E4","E5","MU1",
  "SP1","SP2","SP3","SP4","SP5",
  "RE1","RE2","C1","C2","C3","C4",
  "W1","W2","W3","W4"
];

function safeBool(val) {
  return (val && val.toLowerCase() === "yes") ? "yes" : "no";
}

// Add resetFields helper function
function resetFields(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const inputs = container.querySelectorAll("input, select");
  inputs.forEach(el => {
    if (el.tagName.toLowerCase() === "select") {
      el.selectedIndex = 0;  // reset dropdown
    } else {
      el.value = "";         // reset text/number input
    }
  });
}



// Triggers when user selects address or selects shed/patio
devSelect.addEventListener("change", handleTrigger);
document.getElementById("address").addEventListener("change", handleTrigger);

function handleTrigger() {
  shedFields.classList.add("hidden");
  patioFields.classList.add("hidden");
  sensitiveLabel.classList.add("hidden");
  resetFields("shed-fields");
  resetFields("patio-fields");


  if (devSelect.value === "shed") {
    shedFields.classList.remove("hidden");
    sensitiveLabel.classList.remove("hidden");
  }
  if (devSelect.value === "patio") {
    patioFields.classList.remove("hidden");
  }

  const addr = document.getElementById("address").value.trim();
  if (addr) {
    fetchAddressInfo(addr);
  }
}

async function fetchAddressInfo(address) {
  try {
    const response = await fetch("http://127.0.0.1:5000/address-info", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address })
    });
    const data = await response.json();
    if (data.error) {
      console.error("Error:", data.error);
      return;
    }

    if (data.zoning && AllowedZoning.includes(data.zoning)) {
      document.getElementById("zoning").value = data.zoning;
    } else {
      document.getElementById("zoning").value = "";
    }
    if (data.heritage) document.getElementById("heritage").value = safeBool(data.heritage);
    if (data.foreshore) document.getElementById("foreshore").value = safeBool(data.foreshore);
    if (data.bushfire) document.getElementById("bushfire").value = safeBool(data.bushfire);
    if (data.sensitive_area && document.getElementById("sensitive_area")) {
      document.getElementById("sensitive_area").value = safeBool(data.sensitive_area);
    }
    // if (data.land_size && document.getElementById("land_size")) {
    //   document.getElementById("land_size").value = data.land_size;
    // }
    if (data.land_size !== undefined && document.getElementById("land_size")) {
      const landSizeField = document.getElementById("land_size");
      if (data.land_size === "Unknown") {
        landSizeField.value = "";
        landSizeField.placeholder = "Unknown";
      } else {
          // Always store as string
          landSizeField.value = String(data.land_size);
        }
    }




    console.log("Auto-filled attributes:", data);
  } catch (err) {
    console.error("Fetch failed", err);
  }
}

document.getElementById("submit").addEventListener("click", async () => {
  const dev = devSelect.value;
  if (!dev) { alert("Select development type"); return; }

  const getNumber = id => {
    const el = document.getElementById(id);
    return el && el.value ? Number(el.value) : 0;
  };
  const getValue = (id, fallback = "no") => {
    const el = document.getElementById(id);
    return el ? el.value : fallback;
  };

  let payload = {
    development: dev,
    address: getValue("address", ""),
    zoning: getValue("zoning", ""),
    heritage: getValue("heritage", "no"),
    foreshore: getValue("foreshore", "no"),
    sensitive_area: dev === "shed" ? getValue("sensitive_area", "no") : "no"
  };

  // Sheds
  if (dev === "shed") {
    payload["area"] = getNumber("area");
    payload["height"] = getNumber("height");
    payload["boundary_distance"] = getNumber("boundary_distance");
    payload["building_line"] = getValue("building_line");
    payload["shipping_container"] = getValue("shipping_container");
    payload["stormwater"] = getValue("stormwater");
    payload["metal"] = getValue("metal");
    payload["reflective"] = getValue("reflective");
    payload["bushfire"] = getValue("bushfire");
    payload["distance_dwelling"] = getNumber("distance_dwelling");
    payload["non_combustible"] = getValue("non_combustible");
    payload["adjacent_building"] = getValue("adjacent_building");
    payload["interfere"] = getValue("interfere");
    payload["habitable"] = getValue("habitable");
    payload["easement"] = getValue("easement");
    payload["services"] = getValue("services");
    payload["existing_structures"] = getValue("existing_structures");
  }

  // Patios
  if (dev === "patio") {
    payload["structure_type"] = getValue("structure_type");
    payload["height_existing"] = getNumber("height_existing");
    payload["material_quality"] = getValue("material_quality");
    payload["same_size"] = getValue("same_size");
    payload["area"] = getNumber("area_patio");
    payload["land_size"] = getNumber("land_size", "");   
    payload["total_structures_area"] = getNumber("total_structures_area");
    payload["wall_height"] = getValue("wall_height");
    payload["behind_building_line"] = getValue("behind_building_line");
    payload["boundary_distance"] = getNumber("boundary_distance_patio");
    payload["metal"] = getValue("metal_patio");
    payload["reflective"] = getValue("reflective_patio");
    payload["floor_height"] = getNumber("floor_height");
    payload["roof"] = getValue("roof");
    payload["overhang"] = getNumber("overhang");
    payload["attached"] = getValue("attached");
    payload["above_gutter"] = getValue("above_gutter");
    payload["roof_height"] = getNumber("roof_height");
    payload["fascia_connection"] = getValue("fascia_connection");
    payload["engineer_spec"] = getValue("engineer_spec");
    payload["stormwater"] = getValue("stormwater_patio");
    payload["drainage"] = getValue("drainage");
    payload["bushfire"] = getValue("bushfire");
    payload["distance_dwelling"] = getNumber("distance_dwelling_patio");
    payload["non_combustible"] = getValue("non_combustible_patio");
  }

  const res = await fetch("/get-assessment-result/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  document.getElementById("result").textContent = text;
});

</script>

<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script> 
</body>
</html>
