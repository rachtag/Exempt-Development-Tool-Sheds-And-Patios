"""
ALBURY NSW - EXEMPT DEVELOPMENT ASSESSMENT TOOL FOR SHEDS AND PATIOS

STATE ENVIRONMENTAL PLANNING POLICY (Exempt and Complying Development Codes) 2008 (SEPP)


Part 1, Division 2 Exempt and complying development
1.15 What development is exempt development?
    (1) Development is exempt development for the purposes of this Policy if the developmentâ€”
        (a) is specified in an exempt development code, and
        (b) meets the standards specified for the development, and
        (c) complies with the requirements of this Division for exempt development.
    (2) For the purposes of subclause (1), development that is specified includes any specified limitations as to the land on which that development may be carried out.
        Noteâ€”
        Under section 1.6 of the Act, the carrying out of exempt development does not requireâ€”
        (a) development consent under Part 4 of the Act, or
        (b) environmental impact assessment under Division 5.1 of the Act, or
        (c) State significant infrastructure approval under Division 5.2 of the Act, or
        (d) a certificate under Part 6 of the Act.
1.16 General requirements for exempt development
    (1) To be exempt development for the purposes of this Policy, the developmentâ€”
        (a) must meet the relevant deemed-to-satisfy provisions of the Building Code of Australia, or if there are no such relevant provisions, must be structurally adequate, and
        (b) must not, if it relates to an existing building, cause the building to contravene the Building Code of Australia, and
        (b1) must not be carried out on land that is a declared area of outstanding biodiversity value under the Biodiversity Conservation Act 2016 or declared critical habitat under Part 7A 
             of the Fisheries Management Act 1994, and
        (b2) must not be carried out on land that is, or is part of, a wilderness area (within the meaning of Wilderness Act 1987), and
        (c) must not be carried out on land that is, or on which there is, an item that is listed on the State Heritage Register under the Heritage Act 1977, or that is subject to an interim 
            heritage order under that Act, and
        (d) must not be carried out on land that is described or otherwise identified on a map specified in Schedule 4.
    (1A) Despite subclause (1)(c), if development meets the requirements and standards specified by this Policy and that developmentâ€”
        (a) has been granted an exemption under section 57(2) of the Heritage Act 1977, or
        (b) is subject to an exemption under section 57(1A) or (3) of that Act, the development is exempt development under this Policy.
    (1B) If an item listed on the State Heritage Register is not located on, or does not comprise, the whole of the relevant land, subclause (1)(c) applies only to the part of the land that is described 
         and mapped on that register.
    (1C) If an item not listed on the State Heritage Register but identified as an item of environmental heritage in an environmental planning instrument does not comprise, or is not located on, the whole of 
         the relevant land, any restriction on carrying out development on the relevant land on which the item is located applies only to the part of the land that is described and mapped on that instrument.
    (2) Development that relates to an existing building that is classified under the Building Code of Australia as class 1b or class 2â€“9 is exempt development for the purposes of this Policy only ifâ€”
        (a) the building has a current fire safety certificate or fire safety statement, or
        (b) no fire safety measures are currently implemented, required or proposed for the building.
    (3) To be exempt development for the purposes of this Policy, the development mustâ€”
        (a) be installed in accordance with the manufacturerâ€™s specifications, if applicable, and
        (b) not involve the removal or pruning of a tree or other vegetation that requires a permit, approval or development consent, unless the removal or pruning is carried out in accordance with the permit, 
            approval or development consent,
            Exampleâ€”
            A permit or approval may be required under State Environmental Planning Policy (Biodiversity and
            Conservation) 2021, Chapter 2 or other legislation.
        (c) not involve the removal ofâ€”
            (i) non-friable asbestos from an area of more than 10m2, or
            (ii) friable asbestos.
            Noteâ€”
            Residential buildings constructed before 1990 may contain asbestos. See Code of practice: How to
            safely remove asbestos published by SafeWork NSW in December 2022 and www.asbestos.nsw.gov.au for further information.
    (4) Subclause (3)(c) does not apply if the removal is carried out by a licensed asbestos removalist.
    (5) In this clauseâ€”
        friable asbestos, licensed asbestos removalist and non-friable asbestos have the same meaning as in the Work Health and Safety Regulation 2017.
1.16A Exempt development on land within 18km of Siding Spring Observatory
    (1) Development on land that is less than 18km from the Siding Spring Observatory is not exempt development for the purposes of this Policy if the development has, or will
        require, any form of lighting.
    (2) Development specified in Part 2, Division 1, Subdivision 10A, 10B, 27, 27A or 37 on land that is less than 18km from the Siding Spring Observatory is not exempt
        development for the purposes of this Policy.


Part 2, Division 2, Subdivision 6 Balconies, decks, patios, pergolas, terraces and verandahs
2.11 Specified development
The following development is specified for this codeâ€”
    (a) the construction or installation of a balcony, deck, patio, pergola, terrace or verandah, whether free standing or attached to the ground floor level of a building, or roofed or
        unroofed, if it is not constructed or installed on or in a heritage item or a draft heritage item or on land in a foreshore area,
    (b) the replacement of a deck if the deck is not higher than 1m above ground level (existing).
2.12 Development standards
    (1) The standards specified for the development specified in clause 2.11(a) are that the development mustâ€”
        (a) (Repealed)
        (b) have an area of not more than 25m2, and
        (c) not cause the total floor area of all such structures on the lot to be more thanâ€”
            (i) for a lot larger than 300m2â€”15% of the ground floor area of the dwelling on  the lot, or
            (ii) for a lot 300m2 or lessâ€”25m2, and
        (d) not have an enclosing wall higher than 1.4m, and
        (e) be locatedâ€”
            (i) if carried out in connection with farm experience premises or farm gate premisesâ€”more than 50m from a road, or
            (ii) otherwiseâ€”behind the building line of a road frontage, and
        (f) be located at a distance from each lot boundary of at leastâ€”
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5â€”5m, or
            (ii) for development carried out in any other zoneâ€”900mm, and
        (g) (Repealed)
        (h) to the extent it is comprised of metal componentsâ€”be constructed of low reflective, factory pre-coloured materials, and
        (i) have a floor height not more than 1m above ground level (existing), and
        (i1) if it is a roofed structureâ€”have a roof that does not overhang the structure by more than 600mm on each side,
        (j) if it is a roofed structure attached to a dwellingâ€”not extend above the roof gutter line of the dwelling, and
        (j1) be no higher than 3m at its highest point above ground level (existing), and
        (k) if it is connected to a fasciaâ€”be connected in accordance with a professional engineerâ€™s specifications, and
        (l) be constructed or installed so that any roofwater is disposed of into an existing stormwater drainage system, and
        (m) not interfere with the functioning of existing drainage fixtures or flow paths, and
        (n) if it is located on bush fire prone land and is less than 5m from a dwellingâ€”be constructed of non-combustible material. and
        (o) (Repealed)
    (2) The standards specified for the development specified in clause 2.11(b) are that the development mustâ€”
        (a) use equivalent or improved quality materials, and
        (b) not change the size or height of the existing deck.
    (3) Subclause (1)(h) does not apply to development carried out in connection with a building used for the purposes of farm stay accommodation, farm gate premises or farm experience premises.


Part 2, Division 2, Subdivision 9 Cabanas, cubby houses, ferneries, garden sheds,
gazebos and greenhouses
2.17 Specified development
The construction or installation of a cabana, cubby house, fernery, garden shed, gazebo or greenhouse is development specified for this code if it is not constructed or installed on or
in a heritage item or a draft heritage item, on land in a foreshore area or in an environmentally sensitive area.
2.18 Development standards
    (1) The standards specified for that development are that the development mustâ€”
        (a) (Repealed)
        (b) not have a floor area of more thanâ€”
            (i) on land in Zone RU1, RU2, RU3, RU4, RU6 or R5â€”50m2, or
            (ii) on land in any other zoneâ€”20m2, and
        (c) be not higher than 3m above ground level (existing), and
        (d) be located at a distance from each lot boundary of at leastâ€”
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5â€”5m, or
            (ii) for development carried out in any other zoneâ€”900mm, and
        (e) if it is not on land in Zone RU1, RU2, RU3, RU4 or RU6â€”be located behind the building line of any road frontage, and
        (f) not be a shipping container, and
        (g) be constructed or installed so that roofwater is disposed of without causing a nuisance to adjoining owners, and
        (h) to the extent it is comprised of metal componentsâ€”be constructed of low reflective, factory pre-coloured materials if it is located on land in a residential zone, and
        (i) if it is located on bush fire prone land and is less than 5m from a dwellingâ€”be constructed of non-combustible material, and
        (j) if it is constructed or installed in a heritage conservation area or a draft heritage conservation areaâ€”be located in the rear yard, and
        (k) if it is located adjacent to another buildingâ€”be located so that it does not interfere with the entry to, or exit from, or the fire safety measures contained within, that building, and
        (l) be a Class 10 building and not be habitable, and
        (m) be located at least 1m from any registered easement, and
        (n) in relation to a cabanaâ€”not be connected to water supply or sewerage services.
    (2) There must not be more than 2 developments per lot.


Part 2, Division 2, Subdivision 15 Earthworks, retaining walls and structural support
 2.29 Specified development
 Earthworks and the construction or installation of a retaining wall or other form of structural support is development specified for this code if it is not carried out,
 constructed or installed on or in a heritage item or a draft heritage item, on a flood control lot or in an environmentally sensitive area.
 2.30 Development standards
 The standards specified for that development are that the development mustâ€”
    (a) not be a cut or fill of more than 600mm below or above ground level (existing), and
    (b) be located at least 1m from each lot boundary, and
    (c) if it is carried out, constructed or installed in a heritage conservation area or a draft heritage conservation area â€” be located in the rear yard, and
    (d) be located at least 40m from a waterbody (natural), and
    (e) not redirect the flow of any surface water or ground water or cause sediment to be transported onto an adjoining property, and
    (f) if it is a retaining wall or structural support for excavation or fill, or a combination of  bothâ€”
        (i) be not be more than 600mm high, measured vertically from the base of the development to its uppermost portion, and
        (ii) be separated from any retaining wall or other structural support on the site by at least 2m, measured horizontally, and
        (iii) be located at least 1m from any registered easement, sewer main or water main, and
        (iv) have adequate drainage lines connected to the existing stormwater drainage system for the site, and
    (g) if the fill is more than 150mm deepâ€”not occupy more than 25% of the area of the lot, and
    (h) if the fill is imported to the siteâ€”be free of building and other demolition waste, and only contain virgin excavated natural material (VENM) as 
        defined in Part 3 of Schedule 1 to the Protection of the Environment Operations Act 1997, and
    (i) if the land is in a rural or conservation zone â€” not be fill of more than 100 cubic metres on each lot.


"""

# Import necessary libraries
from flask import Flask, request, jsonify, render_template
from flask import render_template_string
from assessment_db import AssessmentDB
import sqlite3
import json
import os
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from concurrent.futures import ThreadPoolExecutor, TimeoutError as FuturesTimeout

#### GIS Proxy required for geocoding
from GISProxy import geocode_address

# Some constants and helper functions
# Below get_shed_help and get_patio_help provide HTML help information on the required attributes for each development type
get_shed_help = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <title>Shed Assessment Attributes</title>
        <style>
            body {
            font-family: Arial, sans-serif;
            padding: 20px;
            }
            h2 {
            color: #2c3e50;
            }
            table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            }
            th {
            background-color: #f4f4f4;
            }
            caption {
            caption-side: top;
            font-weight: bold;
            margin-bottom: 10px;
            }
        </style>
        </head>
        <body>
        <h2>Shed Assessment Attributes</h2>
        <p>For shed assessment, the JSON file must contain the following attributes:</p>
        <table>
            <thead>
            <tr>
                <th>Attribute Name</th>
                <th>Description</th>
                <th>Valid Options</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>address</td><td>Address of development</td><td></td></tr>
            <tr><td>development</td><td>Type of development</td><td>shed</td></tr>
            <tr><td>zoning</td><td>Land zoning</td><td>R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6</td></tr>
            <tr><td>heritage</td><td>Is the property a heritage item?</td><td>yes, no</td></tr>
            <tr><td>foreshore</td><td>Is the property in a foreshore area?</td><td>yes, no</td></tr>
            <tr><td>sensitive_area</td><td>Is the property in an environmentally sensitive area?</td><td>yes, no</td></tr>
            <tr><td>area</td><td>Planned shed area (in mÂ²)</td><td>numeric</td></tr>
            <tr><td>height</td><td>Planned shed height from ground level (in meters)</td><td>numeric</td></tr>
            <tr><td>boundary_distance</td><td>Distance from any site boundary (in mm)</td><td>numeric</td></tr>
            <tr><td>building_line</td><td>Is the shed behind the building line of road frontage?</td><td>yes, no</td></tr>
            <tr><td>shipping_container</td><td>Is the shed a shipping container?</td><td>yes, no</td></tr>
            <tr><td>stormwater</td><td>Will roofwater be disposed of without causing nuisance to adjoining owners?</td><td>yes, no</td></tr>
            <tr><td>metal</td><td>Will the shed use metal components?</td><td>yes, no</td></tr>
            <tr><td>reflective</td><td>Are metal components low-reflective or factory pre-coloured?</td><td>yes, no</td></tr>
            <tr><td>bushfire</td><td>Is the property on bushfire prone land?</td><td>yes, no</td></tr>
            <tr><td>distance_dwelling</td><td>Distance from dwelling (in meters)</td><td>numeric</td></tr>
            <tr><td>non_combustible</td><td>Will the shed be constructed of non-combustible materials?</td><td>yes, no</td></tr>
            <tr><td>adjacent_building</td><td>Will the shed be adjacent to an existing building?</td><td>yes, no</td></tr>
            <tr><td>interfere</td><td>Will it interfere with entry/exit or fire safety measures of adjacent building?</td><td>yes, no</td></tr>
            <tr><td>habitable</td><td>Is the shed planned to be habitable?</td><td>yes, no</td></tr>
            <tr><td>easement</td><td>Is the shed within 1m of a registered easement?</td><td>yes, no</td></tr>
            <tr><td>services</td><td>Will the shed have water or sewer connections?</td><td>yes, no</td></tr>
            <tr><td>existing_structures</td><td>Are there already two of the following on the lot: cabanas, cubby houses, ferneries, garden sheds, gazebos, greenhouses?</td><td>yes, no</td></tr>
            </tbody>
        </table>
        </body>
        </html>
        """

get_patio_help = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <title>Patio Assessment Attributes</title>
        <style>
            body {
            font-family: Arial, sans-serif;
            padding: 20px;
            }
            h2 {
            color: #2c3e50;
            }
            table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            }
            th {
            background-color: #f4f4f4;
            }
            caption {
            caption-side: top;
            font-weight: bold;
            margin-bottom: 10px;
            }
        </style>
        </head>
        <body>
        <h2>Patio Assessment Attributes</h2>
        <p>For patio assessment, the JSON file must contain the following attributes:</p>
        <table>
            <thead>
            <tr>
                <th>Attribute Name</th>
                <th>Description</th>
                <th>Valid Options</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>address</td><td>Address of development</td><td></td></tr>
            <tr><td>development</td><td>Type of development</td><td>patio</td></tr>
            <tr><td>zoning</td><td>Land zoning</td><td>R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6</td></tr>
            <tr><td>structure_type</td><td>New development or replacing existing structure?</td><td>new, replacement</td></tr>
            <tr><td>height_existing</td><td>Height of existing structure from ground level (in millimeters)</td><td>numeric</td></tr>
            <tr><td>material_quality</td><td>Will the structure use equivalent or better quality materials?</td><td>yes, no</td></tr>
            <tr><td>same_size</td><td>Will the structure be the same height and size as existing?</td><td>yes, no</td></tr>
            <tr><td>heritage</td><td>Is the property a heritage item?</td><td>yes, no</td></tr>
            <tr><td>foreshore</td><td>Is the property in a foreshore area?</td><td>yes, no</td></tr>
            <tr><td>area</td><td>Planned area of structure (in mÂ²)</td><td>numeric</td></tr>
            <tr><td>land_size</td><td>Land size (in mÂ²)</td><td>numeric</td></tr>
            <tr><td>total_structures_area</td><td>Total area of planned + existing structures (in mÂ²)</td><td>numeric</td></tr>
            <tr><td>wall_height</td><td>Will any wall exceed 1.4m in height?</td><td>yes, no</td></tr>
            <tr><td>behind_building_line</td><td>Is the structure behind the building line of road frontage?</td><td>yes, no</td></tr>
            <tr><td>boundary_distance</td><td>Distance from site boundary (in mm)</td><td>numeric</td></tr>
            <tr><td>metal</td><td>Will the structure use metal components?</td><td>yes, no</td></tr>
            <tr><td>reflective</td><td>Are metal components non-reflective or factory coloured?</td><td>yes, no</td></tr>
            <tr><td>floor_height</td><td>Floor height from ground level (in mm)</td><td>numeric</td></tr>
            <tr><td>roof</td><td>Will the structure have a roof?</td><td>yes, no</td></tr>
            <tr><td>overhang</td><td>Roof overhang on any side (in mm)</td><td>numeric</td></tr>
            <tr><td>attached</td><td>Will the roof be attached to the dwelling?</td><td>yes, no</td></tr>
            <tr><td>above_gutter</td><td>Will the roof extend above the gutter line?</td><td>yes, no</td></tr>
            <tr><td>roof_height</td><td>Roof height above ground level (in meters)</td><td>numeric</td></tr>
            <tr><td>fascia_connection</td><td>Will the roof be connected to fascia?</td><td>yes, no</td></tr>
            <tr><td>engineer_spec</td><td>Will it be connected per engineers specs?</td><td>yes, no</td></tr>
            <tr><td>stormwater</td><td>Will roofwater be disposed into existing stormwater system?</td><td>yes, no</td></tr>
            <tr><td>drainage</td><td>Will the structure interfere with existing drainage or flow paths?</td><td>yes, no</td></tr>
            <tr><td>bushfire</td><td>Is the property on bushfire prone land?</td><td>yes, no</td></tr>
            <tr><td>distance_dwelling</td><td>Distance from dwelling (in meters)</td><td>numeric</td></tr>
            <tr><td>non_combustible</td><td>Will the patio be constructed of non-combustible materials?</td><td>yes, no</td></tr>
            </tbody>
        </table>
        </body>
        </html>
        """

get_retain_wall_help = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <title>Retaining Wall Assessment Attributes</title>
        <style>
            body {
            font-family: Arial, sans-serif;
            padding: 20px;
            }
            h2 {
            color: #2c3e50;
            }
            table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            }
            th {
            background-color: #f4f4f4;
            }
            caption {
            caption-side: top;
            font-weight: bold;
            margin-bottom: 10px;
            }
        </style>
        </head>
        <body>
        <h2>Retaining Wall Assessment Attributes</h2>
        <p>For retaining wall assessment, the JSON file must contain the following attributes:</p>
        <table>
            <thead>
            <tr>
                <th>Attribute Name</th>
                <th>Description</th>
                <th>Valid Options</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>address</td><td>Address of development</td><td></td></tr>
            <tr><td>development</td><td>Type of development</td><td>retain</td></tr>
            <tr><td>zoning</td><td>Land zoning</td><td>R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6</td></tr>
            <tr><td>heritage</td><td>Is the property a heritage item? </td><td>yes, no</td></tr>
            <tr><td>heritage_conserv</td><td>Is the property in a heritage conservation area?</td><td>yes, no</td></tr>
            <tr><td>foreshore</td><td>Is the property in a foreshore area?</td><td>yes, no</td></tr>
            <tr><td>flood_control_lot</td><td>Is the property in a flood control area?</td><td>yes, no</td></tr>
            <tr><td>cut_or_fill</td><td>Depth of cut or fill required for retaining wall (in mm):</td><td>numeric</td></tr>
            <tr><td>boundary_distance</td><td>Distance from site boundary (in mm): </td><td>numeric</td></tr>
            <tr><td>rear_yard</td><td>Is retaining wall planned to be built in rear yard?</td><td>yes, no</td></tr>
            <tr><td>waterbody_within_40m</td><td>Is lot less than 40m from a natural water body?</td><td>yes, no</td></tr>
            <tr><td>sediment_transfer</td><td>Will planned retaining wall redirect the flow of any surface water or ground water or cause sediment to be transported onto an adjoining property?</td><td>yes, no</td></tr>
            <tr><td>height</td><td>Planned height of retaining wall (in mm):</td><td>numeric</td></tr>
            <tr><td>distance_other</td><td>Closest distance from planned retaining wall to any other structural support (in mm):</td><td>numeric</td></tr>
            <tr><td>distance_easement</td><td>Closest distance from planned retaining wall to an easement or services main (in mm): </td><td>numeric</td></tr>
            <tr><td>stormwater</td><td>Will planned retaining wall have adequate drainage lines connected into existing stormwater system? </td><td>yes, no</td></tr>
            <tr><td>fill_depth</td><td>Depth of fill for retaining wall (in mm):</td><td>numeric</td></tr>
            <tr><td>fill_area</td><td>Area of fill for retaining wall (in mÂ²):</td><td>numeric</td></tr>
            <tr><td>fill_volume</td><td>Volume of fill for retaining wall (in mÂ³):</td><td>numeric</td></tr>
            <tr><td>land_size</td><td>Land size (in mÂ²)</td><td>numeric</td></tr>
            <tr><td>imported_fill</td><td>Will retaining wall be back filled with imported filler? </td><td>yes, no</td></tr>
            <tr><td>venm</td><td>Is imported fill VENM (Virgin Excavated Natural Material)?</td><td>yes, no</td></tr>
            </tbody>
        </table>
        </body>
        </html>
        """




# HTML template with dynamic table rendering
html_template = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Assessment DB Contents</title>
        <style>
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
        </style>
    </head>
    <body>
        <h2>Assessment DB Contents</h2>
        <table>
            <thead>
                <tr>
                    {% for col in columns %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                        {% for cell in row %}
                            <td>{{ cell }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </body>
    </html>
    """

# URL for SEPP legislation reference
SEPP_URL = "https://legislation.nsw.gov.au/view/html/inforce/current/epi-2008-0572#"

# HTML template for embedded SEPP link in results
SEPP_link_template = """<a href="{{ SEPP_URL_link }}">SEPP</a>"""

# Helper function for input validation of numeric inputs
def parse_float(value, default=0.0):
    """ This function provides input validation for numeric inputs """
    try:
        return float(value)
    except (TypeError, ValueError):
        return default

# Patio assessment function
def patio_check(attributes):
    """ This function provides the rule-set for Exempt Development of a Patio under the SEPP
        returning a strings indicating if the proposed development is Exempt or if not, returning
        a list of strings indicating reasons for Not Exempt under SEPP"""
    
    print("\nðŸ”§ Patio Development Check")
    # Initialise a results list for NON-EXEMPT reasons and a list for relevant sections in SEPP for reference
    results = [] 
    relevant_sections = []
    # Initialise an assessment context variable for database logging
    # Possible values: "Exempt", "Non-Exempt", "Invalid"
    context = "Invalid"
    
    try:
        # Clause Part 1, Division 2 Exempt and complying development - Zoning check
        if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            results.append("This tool does not currently support your zone type.  Please contact Albury City Council for further assistance.")
            relevant_sections.append("")

        else:
            # Clause 2.11 and 2.12 - Patio
            # Replacement patio
            # Clause 2.11 (b) - Replacement patio standards
            if attributes["structure_type"] == "replacement":
                if attributes["height_existing"] > 1000:
                    results.append("The proposed structure is higher than 1m above ground level. Please refer to the SEPP legislation for height restrictions:")
                    relevant_sections.append("sec.2.11 (b)")

                # Clause 2.12 (2)(a) - Replacement patio standards
                if attributes["material_quality"] == "no":
                    results.append("The replacement must use materials of equal or better quality. Please refer to the SEPP legislation for material quality restrictions:")
                    relevant_sections.append("sec.2.12 (2)(a)")
        
                # clause 2.12 (2)(b) - Replacement patio standards
                if attributes["same_size"] == "no":
                    results.append("The replacement must be the same size and height as the existing structure. Please refer to the SEPP legislation for size and height restrictions:")
                    relevant_sections.append("sec.2.12 (2)(b)")

            # New patio
            # Clause 2.11 (a) - Heritage item
            if attributes["heritage"] == "yes":
                results.append("The property is a heritage item. Please refer to the SEPP legislation for heritage item restrictions:")
                relevant_sections.append("sec.2.11 (a)")

            # Clause 2.11 (b) - Foreshore area
            if attributes["foreshore"] == "yes":
                results.append("The property is located in a foreshore area. Please refer to the SEPP legislation for foreshore area restrictions:")
                relevant_sections.append("sec.2.11 (b)")

            # Clause 2.11 (b) - Environmentally sensitive area
            if attributes["area"] > 25:
                results.append("The structure floor area is more than 25 mÂ². Please refer to the SEPP legislation for floor area restrictions:")
                relevant_sections.append("sec.2.12 (1)(b)")
            else:
                # Clause 2.12 (1)(c) - Total floor area of all such structures on the lot (for lot size greater than 300m2)
                if attributes["land_size"] > 300:
                    if attributes["total_structures_area"] > 0.15 * attributes["land_size"]:
                        results.append("The combined floor area of similar structures is over the limit for this lot size. Please refer to the SEPP legislation for total floor area restrictions:")
                        relevant_sections.append("sec.2.12 (1)(c)(i)")

                else:
                    # Clause 2.12 (1)(c)(ii) - Total floor area of all such structures on the lot (for lot 300m2 or less)
                    if attributes["total_structures_area"] > 25:
                        results.append("The combined floor area of similar structures is over the limit for this lot size. Please refer to the SEPP legislation for total floor area restrictions:")
                        relevant_sections.append("sec.2.12 (1)(c)(ii)") 

            # Clause 2.12 (1)(d) - Wall height
            if attributes["wall_height"] == "yes":
                results.append("The wall height exceeds 1.4m. Please refer to the SEPP legislation for wall height restrictions:")
                relevant_sections.append("sec.2.12 (1)(d)") 

            # Clause 2.12 (1)(e) - Building line
            if attributes["behind_building_line"] == "no":
                results.append("The structure must be behind the front building line of road frontage. Please refer to the SEPP legislation for building line restrictions:")
                relevant_sections.append("sec.2.12 (1)(e)")

            # Clause 2.12 (1)(f)(ii) - Boundary distance
            if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes["boundary_distance"] < 900:
                results.append("The structure must be at least 900mm from any lot boundary for this zone type. Please refer to the SEPP legislation for boundary distance restrictions:")
                relevant_sections.append("sec.2.12 (1)(f)(ii)")

            # Clause 2.12 (1)(f)(i) - Boundary distance
            if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes["boundary_distance"] < 5000:
                results.append("The structure must be at least 5000mm from any lot boundary for this zone type. Please refer to the SEPP legislation for boundary distance restrictions:")
                relevant_sections.append("sec.2.12 (1)(f)(i)")

            # Clause 2.12 (1)(h) - Metal components
            if attributes["metal"] == "yes":
                if attributes["reflective"] == "no":
                    results.append("The metal components must be low-reflective and factory pre-coloured. Please refer to the SEPP legislation for metal component restrictions:")
                    relevant_sections.append("sec.2.12 (1)(h)")

            # Clause 2.12 (1)(i) - Floor height
            if attributes["floor_height"] > 1000:
                results.append("The floor height exceeds 1m above ground level. Please refer to the SEPP legislation for floor height restrictions:")
                relevant_sections.append("sec.2.12 (1)(i)")

            # Clause 2.12 (1)(i1) - Roof overhang
            if attributes["roof"] == "yes":
                if attributes["overhang"] > 600:
                    results.append("The roof overhang exceeds 600mm. Please refer to the SEPP legislation for roof overhang restrictions:")
                    relevant_sections.append("sec.2.12 (1)(i1)")

                # Clause 2.12 (1)(j) - Attached roof
                if attributes["attached"] == "yes":
                    if attributes["above_gutter"] == "yes":
                        results.append("The roof must not extend above the dwellingâ€™s gutter line. Please refer to the SEPP legislation for roof height restrictions:")
                        relevant_sections.append("sec.2.12 (1)(j)")

                    # Clause 2.12 (1)(j1) - Roof height
                    if attributes["roof_height"] > 3:
                        results.append("The roofâ€™s highest point is over 3m above ground level. Please refer to the SEPP legislation for roof height restrictions:")
                        relevant_sections.append("sec.2.12 (1)(j1)")

                    # Clause 2.12 (1)(k) - Fascia connection
                    if attributes["fascia_connection"] == "yes":
                        if attributes["engineer_spec"] == "no":
                            results.append("The fascia connection is not compliant with professional specifications. Please refer to the SEPP legislation for fascia connection restrictions:")
                            relevant_sections.append("sec.2.12 (1)(k)")

                # Clause 2.12 (1)(l) - Stormwater disposal
                    if attributes["stormwater"] == "no":
                        results.append("The roofwater does not dispose into an stormwater drainage system. Please refer to the SEPP legislation for stormwater disposal restrictions:")
                        relevant_sections.append("sec.2.12 (1)(l)")

            # Clause 2.12 (1)(m) - Drainage interference
            if attributes["drainage"] == "yes":
                results.append("The proposed development interferes with existing drainage fixtures or flow paths. Please refer to the SEPP legislation for drainage restrictions:")
                relevant_sections.append("sec.2.12 (1)(m)") 

            # Clause 2.12 (1)(n) - Bushfire prone land
            if attributes["bushfire"] == "yes":
                if attributes["distance_dwelling"] < 5:
                    if attributes["non_combustible"] == "no":
                        results.append("The bushfire material standards are not met. Please refer to the SEPP legislation for bushfire restrictions:")
                        relevant_sections.append("sec.2.12 (1)(n)")

        # Check if any NON-EXEMPT reasons were found and prepare final output
        if len(results) > 0:
            results.insert(0,"The proposed structure DOES NOT qualify for exempt development for the following reasons:")
            relevant_sections.insert(0, "")
            context = "Non-Exempt"
        else:
            # No NON-EXEMPT reasons found, so development is Exempt
            results.append("The proposed structure qualifies for exempt development. For more information, please refer to the SEPP legislation:")
            relevant_sections.append("pt.2-div.1-sdiv.6")
            context = "Exempt"
        
        # Return results, relevant sections and context
        return results, relevant_sections, context
    
    except Exception:
        # Catch any exceptions and return an error message
        results.append(f"Missing or invalid input data. Please check all required fields are provided and valid.")
        relevant_sections.append(f"Attributes File: {attributes}")
        return results, relevant_sections, context


# Shed assessment function
def shed_check(attributes):
    """ This function provides the rule-set for Exempt Development of a Shed under the SEPP
        returning a strings indicating if the proposed development is Exempt or if not, returning
        a list of strings indicating reasons for Not Exempt under SEPP"""

    print("\nðŸ”§ Shed Development Check")
    # Initialise a results list for NON-EXEMPT reasons and a list for relevant sections in SEPP for reference
    results = [] 
    relevant_sections = [] 
    # Initialise an assessment context variable for database logging
    # Possible values: "Exempt", "Non-Exempt", "Invalid"
    context = "Invalid"
    
    try:
        # Clause Part 1, Division 2 Exempt and complying development - Zoning check
        if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            results.append("This tool does not currently support your zone type.  Please contact Albury City Council for further assistance.")
            relevant_sections.append("")
        
        else:
            # Clause 2.17 and 2.18 - Shed
            # Clause 2.17 (a) - Heritage item   
            if attributes["heritage"] == "yes":
                results.append("The property is a heritage item. Please refer to the SEPP legislation for heritage item restrictions:")
                relevant_sections.append("sec.2.17 (a)")    

            # Clause 2.17 (b) - Foreshore area
            if attributes["foreshore"] == "yes":
                results.append("The property is located in a foreshore area. Please refer to the SEPP legislation for foreshore area restrictions:")
                relevant_sections.append("sec.2.17 (b)")

            # Clause 2.17 (b) - Environmentally sensitive area
            if attributes["sensitive_area"] == "yes":
                results.append("The property is located in an environmentally sensitive area. Please refer to the SEPP legislation for environmentally sensitive area restrictions:")
                relevant_sections.append("sec.2.17 (b)")

            # Clause 2.18 (1)(b)(ii) - Floor area for zones R1, R2, R3, R4
            if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes ["area"] > 20:
                results.append("The proposed structure's floor area exceeds the limit of 20mÂ². Please refer to the SEPP legislation for floor area restrictions:")
                relevant_sections.append("sec.2.18 (1)(b)(ii)")

            # Clause 2.18 (1)(b)(i) - Floor area for zones R5, RU1, RU2, RU3, RU4, RU6
            if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes ["area"] > 50:
                results.append("The proposed structure's floor area exceeds the limit of 50mÂ². Please refer to the SEPP legislation for floor area restrictions:")
                relevant_sections.append("sec.2.18 (1)(b)(i)")

            # Clause 2.18 (1)(c) - Height restriction
            if attributes["height"] > 3:
                results.append("The proposed structure is higher than 3m above ground level. Please refer to the SEPP legislation for height restrictions:")
                relevant_sections.append("sec.2.18 (1)(c)")

            # Clause 2.18 (1)(d)(ii) - Boundary distance for zones R1, R2, R3, R4
            if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes["boundary_distance"] < 900:
                results.append("The structure must be at least 900mm from any lot boundary. Please refer to the SEPP legislation for boundary distance restrictions:")
                relevant_sections.append("sec.2.18 (1)(d)(ii)")
        
            # Clause 2.18 (1)(d)(i) - Boundary distance for zones R5, RU1, RU2, RU3, RU4, RU6
            if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes["boundary_distance"] < 5000:
                results.append("The structure must be at least 5000mm from any lot boundary. Please refer to the SEPP legislation for boundary distance restrictions:")
                relevant_sections.append("sec.2.18 (1)(d)(i)")

            # Clause 2.18 (1)(e) - Building line
            if attributes["building_line"] == "no":
                if attributes["zoning"] not in ["RU1", "RU2", "RU3", "RU4", "RU6"]:
                    results.append("The structure must be behind the building line of road frontage. Please refer to the SEPP legislation for building line restrictions:")
                    relevant_sections.append("sec.2.18 (1)(e)")

            # Clause 2.18 (1)(f) - Shipping container
            if attributes["shipping_container"] == "yes":
                results.append("Shipping containers are not allowed. Please refer to the SEPP legislation for shipping container restrictions:")
                relevant_sections.append("sec.2.18 (1)(f)")

            # Clause 2.18 (1)(g) - Stormwater disposal
            if attributes["stormwater"] == "no":
                results.append("The roofwater disposal may affect your neighbours. Please refer to the SEPP legislation for stormwater disposal restrictions:")
                relevant_sections.append("sec.2.18 (1)(g)")

            # Clause 2.18 (1)(h) - Metal components
            if attributes["metal"] == "yes":
                if attributes["reflective"] == "no":
                    results.append("The metal components are not compliant. Please refer to the SEPP legislation for metal component restrictions:")
                    relevant_sections.append("sec.2.18 (1)(h)")

            # Clause 2.18 (1)(i) - Bushfire prone land
            if attributes["bushfire"] == "yes":
                if attributes["distance_dwelling"] < 5:
                    if attributes["non_combustible"] == "no":
                        results.append("The bushfire material standards are not met. Please refer to the SEPP legislation for bushfire restrictions:")
                        relevant_sections.append("sec.2.18 (1)(i)")

            # Clause 2.18 (1)(j) - Distance from dwelling
            if attributes["adjacent_building"] == "yes":
                if attributes["interfere"] == "yes":
                    results.append("The structure interferes with building access or safety. Please refer to the SEPP legislation for adjacent building restrictions:")
                    relevant_sections.append("sec.2.18 (1)(k)")

            # Clause 2.18 (1)(l) - Habitable buildings
            if attributes["habitable"] == "yes":
                results.append("The proposed structure cannot be used as habitable buildings. Please refer to the SEPP legislation for habitable building restrictions:")
                relevant_sections.append("sec.2.18 (1)(l)")

            # Clause 2.18 (1)(m) - Easements
            if attributes["easement"] == "yes":
                results.append("The proposed structure must be at least 1m from any easement. Please refer to the SEPP legislation for easement restrictions:")
                relevant_sections.append("sec.2.18 (1)(m)")

            # Clause 2.18 (1)(n) - Services
            if attributes["services"] == "yes":
                results.append("Service connections are not allowed. Please refer to the SEPP legislation for service connection restrictions:")
                relevant_sections.append("sec.2.18 (1)(n) ")

            # Clause 2.18 (2) - Existing structures
            if attributes["existing_structures"] == "yes":
                results.append("More than two similar structures already exist on the property. Please refer to the SEPP legislation for existing structure restrictions:")
                relevant_sections.append("sec.2.18 (2)")

        # Check if any NON-EXEMPT reasons were found and prepare final output
        if len(results) > 0:
            results.insert(0,"The proposed structure DOES NOT qualify for exempt development for the following reasons:")
            relevant_sections.insert(0, "")
            context = "Non-Exempt"
        else:
            # No NON-EXEMPT reasons found, so development is Exempt
            results.append("The proposed structure qualifies for exempt development. For more information, please refer to the SEPP legislation:")
            relevant_sections.append("pt.2-div.1-sdiv.9")
            context = "Exempt"

        # Return results, relevant sections and context
        return results, relevant_sections, context
    
    except Exception:
        # Catch any exceptions and return an error message
        results.append(f"Missing or invalid input data. Please check all required fields are provided and valid.")
        relevant_sections.append(f"Attributes File: {attributes}")
        return results, relevant_sections, context


def retain_wall_check(attributes):
    """ This function provides the rule-set for Exempt Development of a retaining wall under the SEPP
    returning a strings indicating if the proposed development is Exempt or if not, returning
    a list of strings indicating reasons for Not Exempt under SEPP"""

    print("\nðŸ”§ Retaining Wall Development Check")
    # Initialise a results list for NON-EXEMPT reasons and a list for relevant sections in SEPP for reference
    results = [] 
    relevant_sections = [] 
    # Initialise an assessment context variable for database logging
    # Possible values: "Exempt", "Non-Exempt", "Invalid"
    context = "Invalid"
    
    try:
        # Clause Part 1, Division 2 Exempt and complying development - Zoning check
        if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            results.append("This tool does not currently support your zone type.  Please contact Albury City Council for further assistance.")
            relevant_sections.append("")
        
        else:
            # Clause 2.29 - Heritage item
            if attributes["heritage"] == "yes":
                results.append("The property is a heritage item. Please refer to the SEPP legislation for heritage item restrictions:")
                relevant_sections.append("sec.2.29")    

            # Clause 2.29 - Foreshore area
            if attributes["foreshore"] == "yes":
                results.append("The property is located in a foreshore area. Please refer to the SEPP legislation for foreshore area restrictions:")
                relevant_sections.append("sec.2.29")

            # Clause 2.29 - Flood control lot
            if attributes["flood_control_lot"] == "yes":
                results.append("The property is located in an flood control lot. Please refer to the SEPP legislation for flood control lot restrictions:")
                relevant_sections.append("sec.2.29")

            # Clause 2.30(a) - Cut or fill depth
            if attributes["cut_or_fill"] > 600:
                results.append("Cut or Fill of Retaining Wall exceeds 600mm.  Please refer to the SEPP legislation for cut and fill restrictions:")
                relevant_sections.append("sec.2.30 (a)")

            # Clause 2.30(b) - Boundary distance
            if attributes["boundary_distance"] < 1000:
                results.append("The Retaining Wall must be at least 1000mm from any lot boundary. Please refer to the SEPP legislation for boundary distance restrictions:")
                relevant_sections.append("sec.2.30 (b)")

            # Clause 2.30(c) - Heritage conservation area
            if attributes["heritage_conserv"] == "yes":
                if attributes["rear_yard"] == "no":
                    results.append("For a property in a heritage conservation area, development must be in rear yard. Please refer to the SEPP legislation for heritage conservation area restrictions:")
                    relevant_sections.append("sec.2.30 (c)") 

            # Clause 2.30(d) - Natural waterbody
            if attributes["waterbody_within_40m"] == "yes":
                results.append("The retaining wall is less than 40m from a natural waterbody. Please refer to the SEPP legislation for natural waterbody restrictions:")
                relevant_sections.append("sec.2.30 (d)")

            # Clause 2.30(e) - Sediment transfer
            if attributes["sediment_transfer"] == "yes":
                results.append("The retaining wall may causes sediment transfer to adjoining property. Please refer to the SEPP legislation for water flow restrictions:")
                relevant_sections.append("sec.2.30 (e)")

            # Clause 2.30(f)(i) - Height restriction
            if attributes["height"] > 600:
                results.append("The retaining wall exceeds 600mm in height. Please refer to the SEPP legislation for retaining wall height restrictions:")
                relevant_sections.append("sec.2.30 (f)(i)")

            # Clause 2.30(f)(ii) - Distance to other structural support
            if attributes["distance_other"] < 2000:
                results.append("The retaining wall is less than 2000mm from another structural support. Please refer to the SEPP legislation for structural support distance restrictions:")
                relevant_sections.append("sec.2.30 (f)(ii)")

            # Clause 2.30(f)(iii) - Distance to easement or services main
            if attributes["distance_easement"] < 1000:
                results.append("The retaining wall is less than 1000mm from a registered easement or services main. Please refer to the SEPP legislation for easement and services main distance restrictions:")
                relevant_sections.append("sec.2.30 (f)(iii)")

            # Clause 2.30(f)(iv) - Stormwater disposal
            if attributes["stormwater"] == "no":
                results.append("The retaining wall does not dispose of stormwater adequately. Please refer to the SEPP legislation for stormwater disposal restrictions:")
                relevant_sections.append("sec.2.30 (f)(iv)")

            # Clause 2.30(g) - Fill depth and area
            if attributes["fill_depth"] > 150:
                if attributes["fill_area"] > 0.25 * attributes["land_size"]:
                    results.append("The fill exceeds 150mm and occupies more than 25% of the lot area. Please refer to the SEPP legislation for fill restrictions:")
                    relevant_sections.append("sec.2.30 (g)")

            # Clause 2.30(h) - Imported fill
            if attributes["imported_fill"] == "yes":
                if attributes["venm"] == "no":
                    results.append("Imported fill must be VENM (virgin excavated natural material. Please refer to the SEPP legislation for imported fill restrictions:")
                    relevant_sections.append("sec.2.30 (h)")

            # Clause 2.30(i) - Fill volume for rural zones or heritage conservation area
            if attributes["zoning"] in ["RU1", "RU2", "RU3", "RU4", "RU6"] or ["heritage_conserv"] == "yes":
                if attributes["fill_volume"] > 100:
                    results.append("The fill volume exceeds 100mÂ³ for rural zones or heritage conservation areas. Please refer to the SEPP legislation for fill volume restrictions:")
                    relevant_sections.append("sec.2.30 (i)")

        # Check if any NON-EXEMPT reasons were found and prepare final output
        if len(results) > 0:
            results.insert(0,"The proposed structure DOES NOT qualify for exempt development for the following reasons:")
            relevant_sections.insert(0, "")
            context = "Non-Exempt"
        else:
            # No NON-EXEMPT reasons found, so development is Exempt
            results.append("The proposed structure qualifies for exempt development. For more information, please refer to the SEPP legislation:")
            relevant_sections.append("pt.2-div.1-sdiv.15")
            context = "Exempt"

        # Return results, relevant sections and context
        return results, relevant_sections, context
    
    except Exception:
        # Catch any exceptions and return an error message
        results.append(f"Missing or invalid input data. Please check all required fields are provided and valid.")
        relevant_sections.append(f"Attributes File: {attributes}")
        return results, relevant_sections, context


# Create API
# Initialize Flask application instance
app = Flask(__name__)
app.config["RATELIMIT_HEADERS_ENABLED"] = True

# Request/Response timeout
EXECUTOR = ThreadPoolExecutor(max_workers=4)
REQUEST_TIMEOUT_SECONDS = int(os.getenv("REQUEST_TIMEOUT_SECONDS", 30))

def run_with_timeout(fn, *args, timeout=REQUEST_TIMEOUT_SECONDS):
    fut = EXECUTOR.submit(fn, *args)
    try:
        return fut.result(timeout=timeout)
    except FuturesTimeout:
        fut.cancel()
        raise

# Rate limiting setup 
DEFAULT_LIMIT = os.getenv("RATE_LIMIT_DEFAULT", "30 per minute")
VALIDATE_LIMIT = os.getenv("RATE_LIMIT_VALIDATE", "10 per 30 seconds")  # for assessment endpoint
LOGGING_LIMIT  = os.getenv("RATE_LIMIT_LOGGING",  "10 per minute")      # for /get-logging-db/
HELP_LIMIT     = os.getenv("RATE_LIMIT_HELP",     "30 per minute")
STORAGE_URI    = os.getenv("LIMITER_STORAGE_URI", "memory://")          

limiter = Limiter(
    key_func=get_remote_address,          # per-IP by default; swap to user-id if you add auth
    default_limits=[DEFAULT_LIMIT],
    storage_uri=STORAGE_URI
)
limiter.init_app(app)

@app.after_request
def expose_rate_limit_headers(resp):
    # Make rate-limit headers readable by frontend JS (if on a different origin)
    resp.headers["Access-Control-Expose-Headers"] = \
        "X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, Retry-After"
    return resp

@app.errorhandler(429)
def ratelimit_handler(e):
    # Flask-Limiter will set Retry-After and X-RateLimit-* headers; return a friendly JSON
    return jsonify({"error": "rate_limited",
                    "message": "Too many requests. Please try again later."}), 429


# Define route for homepage; serves the main HTML form interface for shed/patio assessment (ExemptAssessAPI)
@app.route("/")
def index():
    # Render the frontend form (located in /templates/index.html)
    return render_template("index.html")


# Define route page to return assessment results based on user input via POST request
@app.route("/get-assessment-result/", methods=["POST"])
@limiter.limit(VALIDATE_LIMIT)  # Apply rate limit to assessment endpoint
def API_assessment():
    attributes = request.get_json(silent=True) or {}

    # TESTING: debug slowness via query param (?debug_sleep=40)
    #try:
        #debug_sleep = int(request.args.get("debug_sleep", "0"))
    #except ValueError:
        #debug_sleep = 0
    #if debug_sleep > 0:
        #import time
        #time.sleep(debug_sleep)
    # end testing code
        
    try:
        return run_with_timeout(Assess, attributes)
    except FuturesTimeout:
        return jsonify({
            "error": "timeout",
            "message": f"Processing took longer than {REQUEST_TIMEOUT_SECONDS}s. Please try again."
        }), 504
    

# Define route to return help information on required attributes for shed and patio assessments via GET request
@app.route("/get-assessment-help/", methods=["GET"])
@limiter.limit(HELP_LIMIT)  # Apply rate limit to help endpoint
def API_assessment_help():
    # Return combined help documentation for shed and patio attributes (used for frontend guidance or API introspection)
    return get_shed_help + get_patio_help + get_retain_wall_help


# Define route to retrieve and display logged assessments from the database with optional filtering via GET request
# This is primarily for demonstration, testing and debugging purposes
# User can filter by assessment ID or limit number of recent entries returned
# Usage examples:
# /get-logging-db/?id=1  (to get assessment with ID 1)
# /get-logging-db/?limit=10  (to get the 10 most recent assessments)
# /get-logging-db/  (to get all assessments)
# This should probably be changed to a more secure admin-only view in a production system
@app.route("/get-logging-db/", methods=["GET"])
@limiter.limit(LOGGING_LIMIT)   # Apply rate limit to logging endpoint
def get_logging_dbx():
    limited = request.args.get('limit', default=-1, type=int)
    id = request.args.get('id', default=None, type=int)
    
    # Connect to the SQLite database
    db = AssessmentDB()

    # Fetch requested rows from the assessments database table
    if id is not None:
        # Get specific assessment by ID
        rows = db.get_assessment_id(assessment_id=id)
    else:
        # Get limited number of recent assessments
        rows = db.get_recent_assessments(limit=limited)

    # Get column names for header
    column_names = [description[0] for description in db.cursor.description]

    db.close()

    # Render the results in an HTML table using the template
    return render_template_string(html_template, columns=column_names, rows=rows)


# Define a route to clear the logging database (for testing purposes)
@app.route("/clear-logging-db/", methods=["GET"])
@limiter.limit(LOGGING_LIMIT)   # Apply rate limit to logging endpoint
def clear_logging_dbx():
    db = AssessmentDB()
    db.clear_assessments()
    db.close()
    return "Logging database cleared."
    

#### GisProxy Route for Geocoding ########
@app.route("/geocode", methods=["GET"])
def API_geocode():
    address = request.args.get("address")
    result = geocode_address(address)
    return jsonify(result)


# Define the main assessment function that routes to specific development checks based on input attributes
def Assess(attributes):
    # Initialise an empty list to hold the full result including relevant SEPP sections and explanatory links
    full_result = []

    # Make a copy of original attributes for logging purposes
    attributes_received = attributes.copy()

    # Extract address for logging or future audit trail (default fallback if missing)
    address = attributes.get("address", "No address provided")
    
    # Do some basic validation of input attributes but this should really be done in the frontend
    for attrib in attributes:
        # Normalise string inputs to lowercase and strip whitespace (except zoning which should be uppercase)
        if isinstance(attributes[attrib], str):
            if attrib == "zoning":  # Zones should be in capital letters
                attributes[attrib] = attributes[attrib].upper().strip()
            else:
                attributes[attrib] = attributes[attrib].lower().strip() 
        # Validate numeric inputs, defaulting to 0.0 if invalid or missing
        elif isinstance(attributes[attrib], (int, float)):
            attributes[attrib] = parse_float(attributes[attrib], default=0.0)   
        else:
            # For any other data types, retain the original value
            attributes[attrib] = attributes[attrib]
        # Default any missing string attributes to "no" for binary yes/no fields
        if attributes[attrib] == "" or attributes[attrib] is None:
            attributes[attrib] = "no"

    # Route to appropriate rules engine based on development type and get assessment results
    if attributes["development"] == "patio":
        # Applies patio-specific rules from schema
        result, relevant_sections, context = patio_check(attributes)  
    elif attributes["development"] == "shed":
        # Applies shed-specific rules from schema
        result, relevant_sections, context = shed_check(attributes)
    elif attributes["development"] == "retain":
        # Applies retaining wall-specific rules from schema
        result, relevant_sections, context = retain_wall_check(attributes)
    else:
        # Handle invalid development type with fallback messaging and context flag
        result, relevant_sections, context = ["The development type is not supported."], ["Please use 'shed' or 'patio' as the development type."], "Invalid"

    # Prepare and format the full result for output
    # Add header and footer for clarity when output to console
    print("--------------------------------------------------------------------------------------------------------------------")
    print(f"ðŸ“‹ Assessment Result for : {address}")
    print("--------------------------------------------------------------------------------------------------------------------")
  
    # Build the full result list for output including relevant SEPP sections and links
    # Iterate through each rule result and append to output list
    for section in range(len(relevant_sections)):
            full_result.append(result[section])
            
            # If context is invalid, append guidance and exit early
            if context == "Invalid" and section == 0:
                full_result.append(relevant_sections[section])
                break

            # If SEPP section is provided, append full URL for user reference
            if relevant_sections[section] != "":
                full_result.append(f"{SEPP_URL}{relevant_sections[section]}")
    
    # Print the full result to console for logging/debugging purposes
    for line in full_result:
        print(line)

    # Add footer with SEPP reference
    print("--------------------------------------------------------------------------------------------------------------------")
    print("################ Subject to conditions listed in SEPP Division 2 - Exempt and Complying Development ################")
    print("--------------------------------------------------------------------------------------------------------------------")
    print("\n")

    # Save Assessment results to database
    db = AssessmentDB()

    # Save assessment result as `context`, `input_data`, and `response_data`
    # Where `input_data` and `response_data` are JSON strings
    # and `context` is a string to identify the type of assessment result {"Exempt", "Non-Exempt", "Invalid"}
    db.save_assessment(
        context = context,
        input_json = json.dumps(attributes_received),
        response_json = json.dumps({"result": full_result})
        )

    db.close()

    # Return the full result list to the frontend for display
    return full_result

# for testing timeout response
#@app.get("/debug/sleep/<int:secs>")
#def debug_sleep(secs):
    #import time
    #time.sleep(secs)
    #return f"slept {secs}s"

# for testing timeout response
#@app.get("/debug/sleep_guarded/<int:secs>")
#def debug_sleep_guarded(secs):
    #import time
    #def _work():
        #time.sleep(secs)
        #return f"slept {secs}s"
    #try:
        #return run_with_timeout(_work)          # uses REQUEST_TIMEOUT_SECONDS (e.g., 30)
    #except FuturesTimeout:
        #return jsonify({
            #"error": "timeout",
            #"message": f"Processing took longer than {REQUEST_TIMEOUT_SECONDS}s. Please try again."
        #}), 504

if __name__ == "__main__":
    # Run the API
    #app.run(debug=True)
    app.run()





