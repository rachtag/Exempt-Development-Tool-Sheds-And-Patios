"""
ALBURY NSW - EXEMPT DEVELOPMENT ASSESSMENT TOOL FOR SHEDS AND PATIOS

STATE ENVIRONMENTAL PLANNING POLICY (Exempt and Complying Development Codes) 2008 (SEPP)


Part 1, Division 2 Exempt and complying development
1.15 What development is exempt development?
    (1) Development is exempt development for the purposes of this Policy if the development—
        (a) is specified in an exempt development code, and
        (b) meets the standards specified for the development, and
        (c) complies with the requirements of this Division for exempt development.
    (2) For the purposes of subclause (1), development that is specified includes any specified limitations as to the land on which that development may be carried out.
        Note—
        Under section 1.6 of the Act, the carrying out of exempt development does not require—
        (a) development consent under Part 4 of the Act, or
        (b) environmental impact assessment under Division 5.1 of the Act, or
        (c) State significant infrastructure approval under Division 5.2 of the Act, or
        (d) a certificate under Part 6 of the Act.
1.16 General requirements for exempt development
    (1) To be exempt development for the purposes of this Policy, the development—
        (a) must meet the relevant deemed-to-satisfy provisions of the Building Code of Australia, or if there are no such relevant provisions, must be structurally adequate, and
        (b) must not, if it relates to an existing building, cause the building to contravene the Building Code of Australia, and
        (b1) must not be carried out on land that is a declared area of outstanding biodiversity value under the Biodiversity Conservation Act 2016 or declared critical habitat under Part 7A 
             of the Fisheries Management Act 1994, and
        (b2) must not be carried out on land that is, or is part of, a wilderness area (within the meaning of Wilderness Act 1987), and
        (c) must not be carried out on land that is, or on which there is, an item that is listed on the State Heritage Register under the Heritage Act 1977, or that is subject to an interim 
            heritage order under that Act, and
        (d) must not be carried out on land that is described or otherwise identified on a map specified in Schedule 4.
    (1A) Despite subclause (1)(c), if development meets the requirements and standards specified by this Policy and that development—
        (a) has been granted an exemption under section 57(2) of the Heritage Act 1977, or
        (b) is subject to an exemption under section 57(1A) or (3) of that Act, the development is exempt development under this Policy.
    (1B) If an item listed on the State Heritage Register is not located on, or does not comprise, the whole of the relevant land, subclause (1)(c) applies only to the part of the land that is described 
         and mapped on that register.
    (1C) If an item not listed on the State Heritage Register but identified as an item of environmental heritage in an environmental planning instrument does not comprise, or is not located on, the whole of 
         the relevant land, any restriction on carrying out development on the relevant land on which the item is located applies only to the part of the land that is described and mapped on that instrument.
    (2) Development that relates to an existing building that is classified under the Building Code of Australia as class 1b or class 2–9 is exempt development for the purposes of this Policy only if—
        (a) the building has a current fire safety certificate or fire safety statement, or
        (b) no fire safety measures are currently implemented, required or proposed for the building.
    (3) To be exempt development for the purposes of this Policy, the development must—
        (a) be installed in accordance with the manufacturer’s specifications, if applicable, and
        (b) not involve the removal or pruning of a tree or other vegetation that requires a permit, approval or development consent, unless the removal or pruning is carried out in accordance with the permit, 
            approval or development consent,
            Example—
            A permit or approval may be required under State Environmental Planning Policy (Biodiversity and
            Conservation) 2021, Chapter 2 or other legislation.
        (c) not involve the removal of—
            (i) non-friable asbestos from an area of more than 10m2, or
            (ii) friable asbestos.
            Note—
            Residential buildings constructed before 1990 may contain asbestos. See Code of practice: How to
            safely remove asbestos published by SafeWork NSW in December 2022 and www.asbestos.nsw.gov.au for further information.
    (4) Subclause (3)(c) does not apply if the removal is carried out by a licensed asbestos removalist.
    (5) In this clause—
        friable asbestos, licensed asbestos removalist and non-friable asbestos have the same meaning as in the Work Health and Safety Regulation 2017.
1.16A Exempt development on land within 18km of Siding Spring Observatory
    (1) Development on land that is less than 18km from the Siding Spring Observatory is not exempt development for the purposes of this Policy if the development has, or will
        require, any form of lighting.
    (2) Development specified in Part 2, Division 1, Subdivision 10A, 10B, 27, 27A or 37 on land that is less than 18km from the Siding Spring Observatory is not exempt
        development for the purposes of this Policy.


Part 2, Division 2, Subdivision 6 Balconies, decks, patios, pergolas, terraces and verandahs
2.11 Specified development
The following development is specified for this code—
    (a) the construction or installation of a balcony, deck, patio, pergola, terrace or verandah, whether free standing or attached to the ground floor level of a building, or roofed or
        unroofed, if it is not constructed or installed on or in a heritage item or a draft heritage item or on land in a foreshore area,
    (b) the replacement of a deck if the deck is not higher than 1m above ground level (existing).
2.12 Development standards
    (1) The standards specified for the development specified in clause 2.11(a) are that the development must—
        (a) (Repealed)
        (b) have an area of not more than 25m2, and
        (c) not cause the total floor area of all such structures on the lot to be more than—
            (i) for a lot larger than 300m2—15% of the ground floor area of the dwelling on  the lot, or
            (ii) for a lot 300m2 or less—25m2, and
        (d) not have an enclosing wall higher than 1.4m, and
        (e) be located—
            (i) if carried out in connection with farm experience premises or farm gate premises—more than 50m from a road, or
            (ii) otherwise—behind the building line of a road frontage, and
        (f) be located at a distance from each lot boundary of at least—
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5—5m, or
            (ii) for development carried out in any other zone—900mm, and
        (g) (Repealed)
        (h) to the extent it is comprised of metal components—be constructed of low reflective, factory pre-coloured materials, and
        (i) have a floor height not more than 1m above ground level (existing), and
        (i1) if it is a roofed structure—have a roof that does not overhang the structure by more than 600mm on each side,
        (j) if it is a roofed structure attached to a dwelling—not extend above the roof gutter line of the dwelling, and
        (j1) be no higher than 3m at its highest point above ground level (existing), and
        (k) if it is connected to a fascia—be connected in accordance with a professional engineer’s specifications, and
        (l) be constructed or installed so that any roofwater is disposed of into an existing stormwater drainage system, and
        (m) not interfere with the functioning of existing drainage fixtures or flow paths, and
        (n) if it is located on bush fire prone land and is less than 5m from a dwelling—be constructed of non-combustible material. and
        (o) (Repealed)
    (2) The standards specified for the development specified in clause 2.11(b) are that the development must—
        (a) use equivalent or improved quality materials, and
        (b) not change the size or height of the existing deck.
    (3) Subclause (1)(h) does not apply to development carried out in connection with a building used for the purposes of farm stay accommodation, farm gate premises or farm experience premises.


Division 2, Subdivision 9 Cabanas, cubby houses, ferneries, garden sheds,
gazebos and greenhouses
2.17 Specified development
The construction or installation of a cabana, cubby house, fernery, garden shed, gazebo or greenhouse is development specified for this code if it is not constructed or installed on or
in a heritage item or a draft heritage item, on land in a foreshore area or in an environmentally sensitive area.
2.18 Development standards
    (1) The standards specified for that development are that the development must—
        (a) (Repealed)
        (b) not have a floor area of more than—
            (i) on land in Zone RU1, RU2, RU3, RU4, RU6 or R5—50m2, or
            (ii) on land in any other zone—20m2, and
        (c) be not higher than 3m above ground level (existing), and
        (d) be located at a distance from each lot boundary of at least—
            (i) for development carried out in Zone RU1, RU2, RU3, RU4, RU6 or R5—5m, or
            (ii) for development carried out in any other zone—900mm, and
        (e) if it is not on land in Zone RU1, RU2, RU3, RU4 or RU6—be located behind the building line of any road frontage, and
        (f) not be a shipping container, and
        (g) be constructed or installed so that roofwater is disposed of without causing a nuisance to adjoining owners, and
        (h) to the extent it is comprised of metal components—be constructed of low reflective, factory pre-coloured materials if it is located on land in a residential zone, and
        (i) if it is located on bush fire prone land and is less than 5m from a dwelling—be constructed of non-combustible material, and
        (j) if it is constructed or installed in a heritage conservation area or a draft heritage conservation area—be located in the rear yard, and
        (k) if it is located adjacent to another building—be located so that it does not interfere with the entry to, or exit from, or the fire safety measures contained within, that building, and
        (l) be a Class 10 building and not be habitable, and
        (m) be located at least 1m from any registered easement, and
        (n) in relation to a cabana—not be connected to water supply or sewerage services.
    (2) There must not be more than 2 developments per lot.

"""
SEPP_URL = "https://legislation.nsw.gov.au/view/html/inforce/current/epi-2008-0572#"

def parse_float(value, default=0.0):
    """ This function provides input validation for numeric inputs """
    try:
        return float(value)
    except (TypeError, ValueError):
        return default


def patio_check():
    """ This function provides the rule-set for Exempt Development of a Patio under the SEPP
        returning a strings indicating if the proposed development is Exempt or if not, returning
        a list of strings indicating reasons for Not Exempt under SEPP"""
    
    print("\n🔧 Patio Development Check")
    # Initialise a results list for NON-EXEMPT reasons and a list for relevant sections in SEPP for reference
    results = [] 
    relevant_sections = []
    # Initialise an assessment context variable for database logging
    # Possible values: "Exempt", "Non-Exempt", "Invalid"
    context = "Invalid"
    
    try:
        if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            results.append("This tool does not currently support your zone type.")
            relevant_sections.append("Please contact Albury City Council for further assistance.")

        if attributes["structure_type"] == "replacement":
            if attributes["height_existing"] > 1:
                results.append("The proposed structure is higher than 1m above ground level. Please refer to the SEPP legislation for height restrictions:")
                relevant_sections.append("sec.2.11 (b)")

            if attributes["material_quality"] == "no":
                results.append("The replacement must use materials of equal or better quality. Please refer to the SEPP legislation for material quality restrictions:")
                relevant_sections.append("sec.2.12 (2)(a)")
    
            if attributes["same_size"] == "no":
                results.append("The replacement must be the same size and height as the existing structure. Please refer to the SEPP legislation for size and height restrictions:")
                relevant_sections.append("sec.2.12 (2)(b)")

        if attributes["heritage"] == "yes":
            results.append("The property is a heritage item. Please refer to the SEPP legislation for heritage item restrictions:")
            relevant_sections.append("sec.2.11 (a)")

        if attributes["foreshore"] == "yes":
            results.append("The property is located in a foreshore area. Please refer to the SEPP legislation for foreshore area restrictions:")
            relevant_sections.append("sec.2.11 (b)")

        if attributes["area"] > 25:
            results.append("The structure floor area is more than 25 m². Please refer to the SEPP legislation for floor area restrictions:")
            relevant_sections.append("sec.2.12 (1)(b)")
        else:
            if attributes["land_size"] > 300:
                if attributes["total_structures_area"] > 0.15 * attributes["land_size"]:
                    results.append("The combined floor area of similar structures is over the limit for this lot size. Please refer to the SEPP legislation for total floor area restrictions:")
                    relevant_sections.append("sec.2.12 (1)(c)(i)")

            else:
                if attributes["total_structures_area"] > 25:
                    results.append("The combined floor area of similar structures is over the limit for this lot size. Please refer to the SEPP legislation for total floor area restrictions:")
                    relevant_sections.append("sec.2.12 (1)(c)(ii)") 

        if attributes["wall_height"] == "yes":
            results.append("The wall height exceeds 1.4m. Please refer to the SEPP legislation for wall height restrictions:")
            relevant_sections.append("sec.2.12 (1)(d)") 

        if attributes["behind_building_line"] == "no":
            results.append("The structure must be behind the front building line of road frontage. Please refer to the SEPP legislation for building line restrictions:")
            relevant_sections.append("sec.2.12 (1)(e)")

        if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes["boundary_distance"] < 900:
            results.append("The structure must be at least 900mm from any lot boundary for this zone type. Please refer to the SEPP legislation for boundary distance restrictions:")
            relevant_sections.append("sec.2.12 (1)(f)(ii)")

        if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes["boundary_distance"] < 5000:
            results.append("The structure must be at least 5m from any lot boundary for this zone type. Please refer to the SEPP legislation for boundary distance restrictions:")
            relevant_sections.append("sec.2.12 (1)(f)(i)")

        if attributes["metal"] == "yes":
            if attributes["reflective"] == "no":
                results.append("The metal components must be low-reflective and factory pre-coloured. Please refer to the SEPP legislation for metal component restrictions:")
                relevant_sections.append("sec.2.12 (1)(h)")

        if attributes["floor_height"] > 1000:
            results.append("The floor height exceeds 1m above ground level. Please refer to the SEPP legislation for floor height restrictions:")
            relevant_sections.append("sec.2.12 (1)(i)")

        if attributes["roof"] == "yes":
            if attributes["overhang"] > 600:
                results.append("The roof overhang exceeds 600mm. Please refer to the SEPP legislation for roof overhang restrictions:")
                relevant_sections.append("sec.2.12 (1)(i1)")

            if attributes["attached"] == "yes":
                if attributes["above_gutter"] == "yes":
                    results.append("The roof must not extend above the dwelling’s gutter line. Please refer to the SEPP legislation for roof height restrictions:")
                    relevant_sections.append("sec.2.12 (1)(j)")

                if attributes["roof_height"] > 3:
                    results.append("The roof’s highest point is over 3m above ground level. Please refer to the SEPP legislation for roof height restrictions:")
                    relevant_sections.append("sec.2.12 (1)(j1)")

                if attributes["fascia_connection"] == "yes":
                    if attributes["engineer_spec"] == "no":
                        results.append("The fascia connection is not compliant with professional specifications. Please refer to the SEPP legislation for fascia connection restrictions:")
                        relevant_sections.append("sec.2.12 (1)(k)")

                if attributes["stormwater"] == "no":
                    results.append("The roofwater does not dispose into an stormwater drainage system. Please refer to the SEPP legislation for stormwater disposal restrictions:")
                    relevant_sections.append("sec.2.12 (1)(l)")

        if attributes["drainage"] == "yes":
            results.append("The proposed development interferes with existing drainage fixtures or flow paths. Please refer to the SEPP legislation for drainage restrictions:")
            relevant_sections.append("sec.2.12 (1)(m)") 

        if attributes["bushfire"] == "yes":
            if attributes["distance_dwelling"] < 5:
                if attributes["non_combustible"] == "no":
                    results.append("The bushfire material standards are not met. Please refer to the SEPP legislation for bushfire restrictions:")
                    relevant_sections.append("sec.2.12 (1)(n)")

        if len(results) > 0:
            results.insert(0,"The proposed structure DOES NOT qualify for exempt development for the following reasons:")
            relevant_sections.insert(0, "")
            context = "Non-Exempt"
        else:
            results.append("The proposed structure qualifies for exempt development. For more information, please refer to the SEPP legislation:")
            relevant_sections.append("pt.2-div.1-sdiv.6")
            context = "Exempt"

        return results, relevant_sections, context
    
    except Exception:
        results.append(f"Missing or invalid input data. Please check all required fields are provided and valid.")
        relevant_sections.append(f"Attributes File: {attributes}")
        return results, relevant_sections, context


def shed_check():
    """ This function provides the rule-set for Exempt Development of a Shed under the SEPP
        returning a strings indicating if the proposed development is Exempt or if not, returning
        a list of strings indicating reasons for Not Exempt under SEPP"""

    print("\n🔧 Shed Development Check")
    # Initialise a results list for NON-EXEMPT reasons and a list for relevant sections in SEPP for reference
    results = [] 
    relevant_sections = [] 
    # Initialise an assessment context variable for database logging
    # Possible values: "Exempt", "Non-Exempt", "Invalid"
    context = "Invalid"
    
    try:

        if attributes["zoning"] not in ["R1", "R2", "R3", "R4", "R5", "RU1", "RU2", "RU3", "RU4", "RU6"]:
            results.append("This tool does not currently support your zone type.")
            relevant_sections.append("Please contact Albury City Council for further assistance.")

        if attributes["heritage"] == "yes":
            results.append("The property is a heritage item. Please refer to the SEPP legislation for heritage item restrictions:")
            relevant_sections.append("sec.2.17 (a)")    

        if attributes["foreshore"] == "yes":
            results.append("The property is located in a foreshore area. Please refer to the SEPP legislation for foreshore area restrictions:")
            relevant_sections.append("sec.2.17 (b)")

        if attributes["sensitive_area"] == "yes":
            results.append("The property is located in an environmentally sensitive area. Please refer to the SEPP legislation for environmentally sensitive area restrictions:")
            relevant_sections.append("sec.2.17 (b)")

        if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes ["area"] > 20:
            results.append("The proposed structure's floor area exceeds the limit of 20m². Please refer to the SEPP legislation for floor area restrictions:")
            relevant_sections.append("sec.2.18 (1)(b)(ii)")

        if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes ["area"] > 50:
            results.append("The proposed structure's floor area exceeds the limit of 50m². Please refer to the SEPP legislation for floor area restrictions:")
            relevant_sections.append("sec.2.18 (1)(b)(i)")

        if attributes["height"] > 3:
            results.append("The proposed structure is higher than 3m above ground level. Please refer to the SEPP legislation for height restrictions:")
            relevant_sections.append("sec.2.18 (1)(c)")

        if attributes["zoning"] in ["R1", "R2", "R3", "R4"] and attributes["boundary_distance"] < 900:
            results.append("The structure must be at least 900mm from any lot boundary. Please refer to the SEPP legislation for boundary distance restrictions:")
            relevant_sections.append("sec.2.18 (1)(d)(ii)")
    
        if attributes["zoning"] in ["R5", "RU1", "RU2", "RU3", "RU4", "RU6"] and attributes["boundary_distance"] < 5000:
            results.append("The structure must be at least 5000mm from any lot boundary. Please refer to the SEPP legislation for boundary distance restrictions:")
            relevant_sections.append("sec.2.18 (1)(d)(i)")

        if attributes["building_line"] == "no":
            if attributes["zoning"] not in ["RU1", "RU2", "RU3", "RU4", "RU6"]:
                results.append("The structure must be behind the building line of road frontage. Please refer to the SEPP legislation for building line restrictions:")
                relevant_sections.append("sec.2.18 (1)(e)")

        if attributes["shipping_container"] == "yes":
            results.append("Shipping containers are not allowed. Please refer to the SEPP legislation for shipping container restrictions:")
            relevant_sections.append("sec.2.18 (1)(f)")

        if attributes["stormwater"] == "no":
            results.append("The roofwater disposal may affect your neighbours. Please refer to the SEPP legislation for stormwater disposal restrictions:")
            relevant_sections.append("sec.2.18 (1)(g)")

        if attributes["metal"] == "yes":
            if attributes["reflective"] == "no":
                results.append("The metal components are not compliant. Please refer to the SEPP legislation for metal component restrictions:")
                relevant_sections.append("sec.2.18 (1)(h)")

        if attributes["bushfire"] == "yes":
            if attributes["distance_dwelling"] < 5:
                if attributes["non_combustible"] == "no":
                    results.append("The bushfire material standards are not met. Please refer to the SEPP legislation for bushfire restrictions:")
                    relevant_sections.append("sec.2.18 (1)(i)")

        if attributes["adjacent_building"] == "yes":
            if attributes["interfere"] == "yes":
                results.append("The structure interferes with building access or safety. Please refer to the SEPP legislation for adjacent building restrictions:")
                relevant_sections.append("sec.2.18 (1)(k)")

        if attributes["habitable"] == "yes":
            results.append("The proposed structure cannot be used as habitable buildings. Please refer to the SEPP legislation for habitable building restrictions:")
            relevant_sections.append("sec.2.18 (1)(l)")

        if attributes["easement"] == "yes":
            results.append("The proposed structure must be at least 1m from any easement. Please refer to the SEPP legislation for easement restrictions:")
            relevant_sections.append("sec.2.18 (1)(m)")

        if attributes["services"] == "yes":
            results.append("Service connections are not allowed. Please refer to the SEPP legislation for service connection restrictions:")
            relevant_sections.append("sec.2.18 (1)(n) ")

        if attributes["existing_structures"] == "yes":
            results.append("More than two similar structures already exist on the property. Please refer to the SEPP legislation for existing structure restrictions:")
            relevant_sections.append("sec.2.18 (2)")

        if len(results) > 0:
            results.insert(0,"The proposed structure DOES NOT qualify for exempt development for the following reasons:")
            relevant_sections.insert(0, "")
            context = "Non-Exempt"
        else:
            results.append("The proposed structure qualifies for exempt development. For more information, please refer to the SEPP legislation:")
            relevant_sections.append("pt.2-div.1-sdiv.9")
            context = "Exempt"

        return results, relevant_sections, context
    
    except Exception:
        results.append(f"Missing or invalid input data. Please check all required fields are provided and valid.")
        relevant_sections.append(f"Attributes File: {attributes}")
        return results, relevant_sections, context


from flask import Flask, request, jsonify, render_template
from flask import render_template_string
from assessment_db import AssessmentDB
import sqlite3
import json

# Create API
# Initialize Flask application instance
app = Flask(__name__)

# Define route for homepage; serves the main HTML form interface for shed/patio assessment
@app.route("/")
def index():
    # Render the frontend form (located in /templates/index.html)
    return render_template("index.html")

# Define route page to return assessment results based on user input via POST or provide help info via GET

@app.route("/get-assessment-result/", methods=["POST"])
def API_assessment():
    # Store incoming attributes globally for access across functions
    global attributes 
    # Parse JSON payload from frontend form submission
    attributes = request.get_json()
    # Pass attributes to assessment engine and return result
    return Assess(attributes)

@app.route("/get-assessment-help/", methods=["GET"])
def API_assessment_help():
    # Return combined help documentation for shed and patio attributes (used for frontend guidance or API introspection)
    return get_shed_help + get_patio_help

# Define route to retrieve and display all logged assessments from the database in a simple HTML table
@app.route("/get-logging-db/", methods=["GET"])
def get_logging_db():
    # Connect to the SQLite database
    conn = sqlite3.connect("assessments.db")
    cursor = conn.cursor()

    # Fetch all rows from the assessments table
    cursor.execute("SELECT * FROM assessments")
    rows = cursor.fetchall()

    # Get column names for header
    column_names = [description[0] for description in cursor.description]

    conn.close()

    # HTML template with dynamic table rendering
    html_template = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Assessment DB Contents</title>
        <style>
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
        </style>
    </head>
    <body>
        <h2>Assessment DB Contents</h2>
        <table>
            <thead>
                <tr>
                    {% for col in columns %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                        {% for cell in row %}
                            <td>{{ cell }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </body>
    </html>
    """

    return render_template_string(html_template, columns=column_names, rows=rows)


# Define the main assessment function that routes to specific development checks based on input attributes
def Assess(attributes):
    # Initialise an empty list to hold the full result including relevant SEPP sections and explanatory links
    full_result = []
    # Make a copy of original attributes for logging purposes
    attributes_received = attributes.copy()

    # Extract address for logging or future audit trail (default fallback if missing)
    address = attributes.get("address", "No address provided")
    
    # Do some basic validation of input attributes
    for attrib in attributes:
        # Normalise string inputs to lowercase and strip whitespace
        if isinstance(attributes[attrib], str):
            attributes[attrib] = attributes[attrib].lower().strip()
        # Validate numeric inputs, defaulting to 0.0 if invalid or missing
        elif isinstance(attributes[attrib], (int, float)):
            attributes[attrib] = parse_float(attributes[attrib], default=0.0)   
        else:
            # For any other data types, retain the original value
            attributes[attrib] = attributes[attrib]
        # Default any missing string attributes to "no" for binary yes/no fields
        if attributes[attrib] == "":
            attributes[attrib] = "no"

    # Route to appropriate rules engine based on development type
    if attributes["development"] == "patio":
        # Applies patio-specific rules from schema
        result, relevant_sections, context = patio_check()  
    elif attributes["development"] == "shed":
        # Applies shed-specific rules from schema
        result, relevant_sections, context = shed_check()
    else:
        # Handle invalid development type with fallback messaging and context flag
        result, relevant_sections, context = ["The development type is not supported."], ["Please use 'shed' or 'patio' as the development type."], "Invalid"

    # Iterate through each rule result and append to output list
    for section in range(len(relevant_sections)):
            full_result.append(result[section])
            
            # If context is invalid, append guidance and exit early
            if context == "Invalid" and section == 0:
                full_result.append(relevant_sections[section])
                break

            # If SEPP section is provided, append full URL for user reference
            if relevant_sections[section] != "":
                full_result.append(f"{SEPP_URL}{relevant_sections[section]}")


    print("--------------------------------------------------------------------------------------------------------------------")
    print(f"📋 Assessment Result for : {address}")
    print("--------------------------------------------------------------------------------------------------------------------")
    for line in full_result:
        print(line)
    print("--------------------------------------------------------------------------------------------------------------------")
    print("################ Subject to conditions listed in SEPP Division 2 - Exempt and Complying Development ################")
    print("--------------------------------------------------------------------------------------------------------------------")
    print("\n")

    # Save Assessment results to database
    db = AssessmentDB()

    # Save assessment result as `context`, `input_data`, and `response_data`
    # Where `input_data` and `response_data` are JSON strings
    # and `context` is a string to identify the type of assessment result {"Exempt", "Non-Exempt", "Invalid"}
    db.save_assessment(
        context = context,
        input_json = json.dumps(attributes_received),
        response_json = json.dumps({"result": full_result})
        )

    db.close()

    # Return the full result list to the frontend for display
    return full_result



if __name__ == "__main__":
    
    # Below get_shed_help and get_patio_help provide HTML help information on the required attributes for each development type using GET method

    get_shed_help = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <title>Shed Assessment Attributes</title>
        <style>
            body {
            font-family: Arial, sans-serif;
            padding: 20px;
            }
            h2 {
            color: #2c3e50;
            }
            table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            }
            th {
            background-color: #f4f4f4;
            }
            caption {
            caption-side: top;
            font-weight: bold;
            margin-bottom: 10px;
            }
        </style>
        </head>
        <body>
        <h2>Shed Assessment Attributes</h2>
        <p>For shed assessment, the JSON file must contain the following attributes:</p>
        <table>
            <thead>
            <tr>
                <th>Attribute Name</th>
                <th>Description</th>
                <th>Valid Options</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>address</td><td>Address of development</td><td></td></tr>
            <tr><td>development</td><td>Type of development</td><td>shed</td></tr>
            <tr><td>zoning</td><td>Land zoning</td><td>R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6</td></tr>
            <tr><td>heritage</td><td>Is the property a heritage item?</td><td>yes, no</td></tr>
            <tr><td>foreshore</td><td>Is the property in a foreshore area?</td><td>yes, no</td></tr>
            <tr><td>sensitive_area</td><td>Is the property in an environmentally sensitive area?</td><td>yes, no</td></tr>
            <tr><td>area</td><td>Planned shed area (in m²)</td><td>numeric</td></tr>
            <tr><td>height</td><td>Planned shed height from ground level (in meters)</td><td>numeric</td></tr>
            <tr><td>boundary_distance</td><td>Distance from any site boundary (in mm)</td><td>numeric</td></tr>
            <tr><td>building_line</td><td>Is the shed behind the building line of road frontage?</td><td>yes, no</td></tr>
            <tr><td>shipping_container</td><td>Is the shed a shipping container?</td><td>yes, no</td></tr>
            <tr><td>stormwater</td><td>Will roofwater be disposed of without causing nuisance to adjoining owners?</td><td>yes, no</td></tr>
            <tr><td>metal</td><td>Will the shed use metal components?</td><td>yes, no</td></tr>
            <tr><td>reflective</td><td>Are metal components low-reflective or factory pre-coloured?</td><td>yes, no</td></tr>
            <tr><td>bushfire</td><td>Is the property on bushfire prone land?</td><td>yes, no</td></tr>
            <tr><td>distance_dwelling</td><td>Distance from dwelling (in meters)</td><td>numeric</td></tr>
            <tr><td>non_combustible</td><td>Will the shed be constructed of non-combustible materials?</td><td>yes, no</td></tr>
            <tr><td>adjacent_building</td><td>Will the shed be adjacent to an existing building?</td><td>yes, no</td></tr>
            <tr><td>interfere</td><td>Will it interfere with entry/exit or fire safety measures of adjacent building?</td><td>yes, no</td></tr>
            <tr><td>habitable</td><td>Is the shed planned to be habitable?</td><td>yes, no</td></tr>
            <tr><td>easement</td><td>Is the shed within 1m of a registered easement?</td><td>yes, no</td></tr>
            <tr><td>services</td><td>Will the shed have water or sewer connections?</td><td>yes, no</td></tr>
            <tr><td>existing_structures</td><td>Are there already two of the following on the lot: cabanas, cubby houses, ferneries, garden sheds, gazebos, greenhouses?</td><td>yes, no</td></tr>
            </tbody>
        </table>
        </body>
        </html>
        """

    get_patio_help = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <title>Patio Assessment Attributes</title>
        <style>
            body {
            font-family: Arial, sans-serif;
            padding: 20px;
            }
            h2 {
            color: #2c3e50;
            }
            table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            }
            th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            }
            th {
            background-color: #f4f4f4;
            }
            caption {
            caption-side: top;
            font-weight: bold;
            margin-bottom: 10px;
            }
        </style>
        </head>
        <body>
        <h2>Patio Assessment Attributes</h2>
        <p>For patio assessment, the JSON file must contain the following attributes:</p>
        <table>
            <thead>
            <tr>
                <th>Attribute Name</th>
                <th>Description</th>
                <th>Valid Options</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>address</td><td>Address of development</td><td></td></tr>
            <tr><td>development</td><td>Type of development</td><td>patio</td></tr>
            <tr><td>zoning</td><td>Land zoning</td><td>R1, R2, R3, R4, R5, RU1, RU2, RU3, RU4, RU6</td></tr>
            <tr><td>structure_type</td><td>New development or replacing existing structure?</td><td>new, replacement</td></tr>
            <tr><td>height_existing</td><td>Height of existing structure from ground level (in meters)</td><td>numeric</td></tr>
            <tr><td>material_quality</td><td>Will the structure use equivalent or better quality materials?</td><td>yes, no</td></tr>
            <tr><td>same_size</td><td>Will the structure be the same height and size as existing?</td><td>yes, no</td></tr>
            <tr><td>heritage</td><td>Is the property a heritage item?</td><td>yes, no</td></tr>
            <tr><td>foreshore</td><td>Is the property in a foreshore area?</td><td>yes, no</td></tr>
            <tr><td>area</td><td>Planned area of structure (in m²)</td><td>numeric</td></tr>
            <tr><td>land_size</td><td>Land size (in m²)</td><td>numeric</td></tr>
            <tr><td>total_structures_area</td><td>Total area of planned + existing structures (in m²)</td><td>numeric</td></tr>
            <tr><td>wall_height</td><td>Will any wall exceed 1.4m in height?</td><td>yes, no</td></tr>
            <tr><td>behind_building_line</td><td>Is the structure behind the building line of road frontage?</td><td>yes, no</td></tr>
            <tr><td>boundary_distance</td><td>Distance from site boundary (in mm)</td><td>numeric</td></tr>
            <tr><td>metal</td><td>Will the structure use metal components?</td><td>yes, no</td></tr>
            <tr><td>reflective</td><td>Are metal components non-reflective or factory coloured?</td><td>yes, no</td></tr>
            <tr><td>floor_height</td><td>Floor height from ground level (in mm)</td><td>numeric</td></tr>
            <tr><td>roof</td><td>Will the structure have a roof?</td><td>yes, no</td></tr>
            <tr><td>overhang</td><td>Roof overhang on any side (in mm)</td><td>numeric</td></tr>
            <tr><td>attached</td><td>Will the roof be attached to the dwelling?</td><td>yes, no</td></tr>
            <tr><td>above_gutter</td><td>Will the roof extend above the gutter line?</td><td>yes, no</td></tr>
            <tr><td>roof_height</td><td>Roof height above ground level (in meters)</td><td>numeric</td></tr>
            <tr><td>fascia_connection</td><td>Will the roof be connected to fascia?</td><td>yes, no</td></tr>
            <tr><td>engineer_spec</td><td>Will it be connected per engineers specs?</td><td>yes, no</td></tr>
            <tr><td>stormwater</td><td>Will roofwater be disposed into existing stormwater system?</td><td>yes, no</td></tr>
            <tr><td>drainage</td><td>Will the structure interfere with existing drainage or flow paths?</td><td>yes, no</td></tr>
            <tr><td>bushfire</td><td>Is the property on bushfire prone land?</td><td>yes, no</td></tr>
            <tr><td>distance_dwelling</td><td>Distance from dwelling (in meters)</td><td>numeric</td></tr>
            <tr><td>non_combustible</td><td>Will the patio be constructed of non-combustible materials?</td><td>yes, no</td></tr>
            </tbody>
        </table>
        </body>
        </html>
        """

    # Run the API
    #app.run(debug=True)
    app.run()




