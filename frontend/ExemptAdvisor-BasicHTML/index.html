<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Exempt Development Assessment</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        max-width: 1000px;
      }
      label {
        display: block;
        margin-top: 15px;
      }
      select,
      input {
        width: 100%;
        padding: 6px;
        margin-top: 5px;
      }
      button {
        margin-top: 20px;
        padding: 10px 15px;
      }
      #jsonOutput {
        margin-top: 30px;
        white-space: pre-wrap;
        background: #f4f4f4;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .error {
        border: 2px solid red;
      }
    </style>
  </head>
  <body>
    <h2>Exempt Development Assessment</h2>

    <form id="assessmentForm">
      <label
        >Development Type:
        <select name="development" id="developmentType" required>
          <option value="">Select</option>
          <option value="shed">Shed</option>
          <option value="patio">Patio</option>
        </select>
      </label>

      <div id="dynamicFields"></div>

      <button type="button" onclick="reviewJSON()">Review JSON</button>
      <button type="button" onclick="postJSON()">Submit JSON</button>
    </form>

    <div id="jsonOutput"></div>

    <script>
      const fieldSets = {
        shed: [
          {
            name: "zoning",
            label: "Land zoning",
            type: "select",
            options: [
              "R1",
              "R2",
              "R3",
              "R4",
              "R5",
              "RU1",
              "RU2",
              "RU3",
              "RU4",
              "RU6",
            ],
          },
          {
            name: "heritage",
            label: "Is the property a heritage item?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "foreshore",
            label: "Is the property in a foreshore area?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "sensitive_area",
            label: "Environmentally sensitive area?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "area",
            label: "Planned shed area (m²)",
            type: "number",
            min: 0,
          },
          { name: "height", label: "Shed height (m)", type: "number", min: 0 },
          {
            name: "boundary_distance",
            label: "Boundary distance (mm)",
            type: "number",
            min: 0,
          },
          {
            name: "building_line",
            label: "Behind building line?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "shipping_container",
            label: "Is it a shipping container?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "stormwater",
            label: "Roofwater disposed without nuisance?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "metal",
            label: "Uses metal components?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "reflective",
            label: "Low-reflective or factory coloured?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "bushfire",
            label: "Bushfire prone land?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "distance_dwelling",
            label: "Distance from dwelling (m)",
            type: "number",
            min: 0,
          },
          {
            name: "non_combustible",
            label: "Constructed of non-combustible materials?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "adjacent_building",
            label: "Adjacent to existing building?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "interfere",
            label: "Interfere with fire safety?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "habitable",
            label: "Planned to be habitable?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "easement",
            label: "Within 1m of easement?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "services",
            label: "Water/sewer connections?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "existing_structures",
            label: "Already two structures on lot?",
            type: "select",
            options: ["yes", "no"],
          },
        ],
        patio: [
          {
            name: "zoning",
            label: "Land zoning",
            type: "select",
            options: [
              "R1",
              "R2",
              "R3",
              "R4",
              "R5",
              "RU1",
              "RU2",
              "RU3",
              "RU4",
              "RU6",
            ],
          },
          {
            name: "structure_type",
            label: "New or replacement?",
            type: "select",
            options: ["new", "replacement"],
          },
          {
            name: "height_existing",
            label: "Height of existing structure (m)",
            type: "number",
            min: 0,
          },
          {
            name: "material_quality",
            label: "Equivalent or better materials?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "same_size",
            label: "Same height and size?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "heritage",
            label: "Heritage item?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "foreshore",
            label: "Foreshore area?",
            type: "select",
            options: ["yes", "no"],
          },
          { name: "area", label: "Planned area (m²)", type: "number", min: 0 },
          {
            name: "land_size",
            label: "Land size (m²)",
            type: "number",
            min: 0,
          },
          {
            name: "total_structures_area",
            label: "Total structures area (m²)",
            type: "number",
            min: 0,
          },
          {
            name: "wall_height",
            label: "Any wall > 1.4m?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "behind_building_line",
            label: "Behind building line?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "boundary_distance",
            label: "Boundary distance (mm)",
            type: "number",
            min: 0,
          },
          {
            name: "metal",
            label: "Metal components?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "reflective",
            label: "Non-reflective or factory coloured?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "floor_height",
            label: "Floor height (mm)",
            type: "number",
            min: 0,
          },
          {
            name: "roof",
            label: "Has roof?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "overhang",
            label: "Roof overhang (mm)",
            type: "number",
            min: 0,
          },
          {
            name: "attached",
            label: "Roof attached to dwelling?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "above_gutter",
            label: "Roof above gutter line?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "roof_height",
            label: "Roof height (m)",
            type: "number",
            min: 0,
          },
          {
            name: "fascia_connection",
            label: "Connected to fascia?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "engineer_spec",
            label: "Connected per engineer specs?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "stormwater",
            label: "Roofwater into stormwater system?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "drainage",
            label: "Interfere with drainage?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "bushfire",
            label: "Bushfire prone land?",
            type: "select",
            options: ["yes", "no"],
          },
          {
            name: "distance_dwelling",
            label: "Distance from dwelling (m)",
            type: "number",
            min: 0,
          },
          {
            name: "non_combustible",
            label: "Non-combustible materials?",
            type: "select",
            options: ["yes", "no"],
          },
        ],
      };

      const devType = document.getElementById("developmentType");
      const dynamicFields = document.getElementById("dynamicFields");

      devType.addEventListener("change", renderFields);

      function renderFields() {
        dynamicFields.innerHTML = "";
        const selected = devType.value;
        const fields = fieldSets[selected] || [];

        fields.forEach((field) => {
          const wrapper = document.createElement("label");
          wrapper.textContent = field.label;

          let input;
          if (field.type === "select") {
            input = document.createElement("select");
            input.name = field.name;
            input.required = true;
            input.innerHTML =
              `<option value="">Select</option>` +
              field.options
                .map((opt) => `<option value="${opt}">${opt}</option>`)
                .join("");
          } else {
            input = document.createElement("input");
            input.type = field.type;
            input.name = field.name;
            input.required = true;
            if (field.min !== undefined) input.min = field.min;
            if (field.max !== undefined) input.max = field.max;
          }

          wrapper.appendChild(input);
          dynamicFields.appendChild(wrapper);
        });
      }

      function reviewJSON() {
        const form = document.getElementById("assessmentForm");
        const formData = new FormData(form);
        const json = {};
        let valid = true;

        [...form.elements].forEach((el) => el.classList.remove("error"));

        for (const [key, value] of formData.entries()) {
          const field = form.elements[key];

          if (field && field.required && !value) {
            field.classList.add("error");
            valid = false;
          }

          if (field && field.type === "number") {
            const num = parseFloat(value);
            if (
              isNaN(num) ||
              (field.min && num < parseFloat(field.min)) ||
              (field.max && num > parseFloat(field.max))
            ) {
              field.classList.add("error");
              valid = false;
            } else {
              json[key] = Number.isInteger(num) ? parseInt(value) : num;
              continue;
            }
          }

          json[key] = value;
        }

        document.getElementById("jsonOutput").textContent = valid
          ? JSON.stringify(json, null, 2)
          : "Please correct highlighted fields.";
      }

      function postJSON() {
        const output = document.getElementById("jsonOutput").textContent;
        try {
          const payload = JSON.parse(output);
          fetch("http://127.0.0.1:5000/get-assessment-result/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) =>
              res.ok ? res.text() : Promise.reject(res.statusText)
            )
            .then((data) => alert("Submission successful: " + data))
            .catch((err) => alert("Submission failed: " + err));
        } catch (e) {
          alert("Invalid JSON. Please review before submitting.");
        }
      }
    </script>
  </body>
</html>
